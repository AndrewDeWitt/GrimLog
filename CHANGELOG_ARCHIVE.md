# Changelog Archive

This file contains archived changelog entries. For recent changes (last 30 versions), see [CHANGELOG.md](./CHANGELOG.md).

---

## [4.54.0] - 2025-12-31 - Narrative Tactical Summaries & Leader Rules Accuracy

### Added
- **Narrative Unit Tactical Summaries:**
  - Overhauled unit summaries to use natural language tactical descriptions instead of raw damage numbers.
  - Summaries now include balanced assessments with at least one weakness or counterpoint for every unit.
  - Guidance updated to prioritize deployment, positioning, and target priority advice.

- **Leader Attachment Rules Integration:**
  - Added full support for `leaderRules` and `leaderAbilities` in the dossier analysis context.
  - AI now sees exactly which units a character can attach to (e.g., "CAN LEAD: Blood Claws; Grey Hunters").
  - Prevents AI hallucinations about incorrect character attachments (e.g., Wolf Guard Battle Leader on foot leading Thunderwolf Cavalry).

- **Qualitative Weapon Assessments:**
  - Added profile-based weapon tags (e.g., "anti-armor", "anti-horde") to unit context.
  - Instructed AI to infer capability from weapon stats (S, AP, Damage, Abilities) rather than pre-calculated damage numbers.

### Changed
- **Full Datasheet Context for AI:**
  - Removed 150-character truncation on ability descriptions; AI now receives full ability text for more accurate strategic analysis.
  - Simplified AI prompts by removing pre-calculated MathHammer engagement scenarios in favor of raw profile analysis.

- **Data Enrichment Layer:**
  - Added server-side enrichment in the dossier analysis pipeline to override AI-parsed data with verified database values before context building.

### Fixed
- **Thunderwolf Cavalry Data Correction:**
  - Updated database to remove Legends-only leaders from Thunderwolf Cavalry's competitive ruleset.

### Technical
- Updated: `lib/dossierAnalysis.ts` - Interface expansions, prompt overhaul, and narrative reasoning fallback.
- Updated: `app/api/dossier/analyze/route.ts` - Added `enrichParsedArmyFromDatabase` helper and updated Langfuse tracing.
- Updated: `lib/types.ts` - Expanded `ParsedDatasheet` interface with leader rules.
- Updated: `app/api/armies/parse/route.ts` - Added leader fields to Prisma select and OpenAI function schema.
- Updated: `app/api/datasheets/route.ts` - Added leader fields to public API select.
- Updated: `app/armies/builder/page.tsx` - Updated unit construction to include leader data.

---

## [4.53.0] - 2025-12-31 - AI Unit Summaries & Tactical Role Overhaul

### Added
- **AI-Generated Unit Tactical Summaries:**
  - Every unit in the dossier now includes a 1-2 sentence tactical guide generated by Gemini.
  - Guides provide deployment tips, battlefield usage, and unit synergies.
  - Unit cards in the UI and HTML export now prioritize these summaries over raw stats for better readability.

- **AI Tactical Role Assignments:**
  - AI now dynamically assigns units to one of 8 tactical roles based on actual battlefield purpose, not just raw damage.
  - New Roles: `utility` (Lone Ops, infiltrators) and `specialist` (anti-tank, snipers).
  - AI provides reasoning for each assignment (e.g., "Lone Operative makes them a utility piece for safe scoring").
  - Role grouping in UI and HTML export now uses these AI assignments.

- **Enhanced Tactical Highlights:**
  - Increased number of "Fun Stats" from 3 to 4 to better fill the layout space.
  - Improved AI guidance for "Combat Focus" (Combat Spectrum) to prioritize effective damage over simple weapon counts.
  - Expanded playstyle definitions in AI prompt for more accurate classification (e.g., Space Wolves correctly identified as melee-focused).

### Changed
- **Unit Profile Card Revamp:**
  - Streamlined UI by removing detailed damage charts, weapon breakdowns, and toughness bars.
  - Cards now focus on: Tactical Role, AI Summary, and AI Reasoning.
  - Unit icons in cards now use placeholder emojis matching their tactical role if no image is available.

- **Tactical Highlights Reverted to Emojis:**
  - Reverted the "Tactical Highlights" (fun stats) section to use emojis instead of AI-generated icons.
  - Retained AI-generated icons for the "Army Spirit" hero section (the big icon).
  - Removed batch generation logic and Supabase storage for fun stat icons to improve performance and simplicity.

### Technical
- Updated: `app/api/dossier/analyze/route.ts` - Added `unitTacticalSummaries`, `unitRoleAssignments`, and `funStat4` to JSON schema and prompt.
- Updated: `lib/dossierAnalysis.ts` - Added `TacticalRole` expansions, updated `ViralInsights` types, and improved user prompt for Gemini.
- Updated: `components/DossierReport.tsx` - Role grouping overhaul, `UnitProfileCard` simplification, and emoji fallback logic.
- Updated: `lib/dossierExport.ts` - Updated HTML generation to include AI summaries and assignments, matching UI parity.

---

## [4.52.0] - 2025-12-30 - Astra Militarum & Faction Master Template

### Added
- **Astra Militarum Faction Support:**
  - 68 datasheets imported with full weapons and abilities
  - 7 detachments (including new "Grizzled Company")
  - 42 stratagems and 28 enhancements
  - LLM-powered parsing using Gemini 3 Flash with balanced thinking
  - Points tiers and unit composition support

- **Faction Integration Master Template:**
  - New `FACTION_MASTER_TEMPLATE.md` documentation
  - Comprehensive checklist for adding new factions to the app
  - Verified command list for scraping, parsing, and seeding
  - Standardized troubleshooting for common database transaction timeouts

### Changed
- **Datasheet Parser Optimization:**
  - Switched to Gemini 3 Flash (`gemini-3-flash-preview`) for 50% cost reduction
  - Added `thinkingLevel: 'medium'` for improved complex datasheet parsing
  - Increased `maxOutputTokens` to 65536 to prevent JSON truncation
  - Enhanced retry logic for JSON parsing errors

- **Database Seeding Improvements:**
  - Increased Prisma transaction timeout to 60 seconds for complex datasheets
  - Improved data consistency for large faction imports

---

## [4.51.0] - 2025-12-30 - Dossier Army Spirit & Viral Insights

### Added
- **Army Spirit Hero Section:**
  - AI-generated unique army icon using Gemini image generation
  - Catchy tagline capturing army's battlefield identity (e.g., "The Iron Tide", "Death from Above")
  - Spirit description - evocative one-liner about how the army "feels" on tabletop
  - Icons stored permanently in Supabase Storage for sharing

- **Playstyle Blend Analysis:**
  - Primary and secondary playstyle archetypes with percentages
  - Six archetypes: Alpha Strike, Counterpunch, Castle, Skirmisher, Grinder, Glass Cannon
  - Visual progress bars with archetype-specific colors and icons

- **Combat Spectrum:**
  - Melee â†” Shooting slider visualization (0-100 scale)
  - Contextual description based on army's combat focus

- **Dynamic Fun Stats:**
  - AI picks 3-4 interesting stats unique to each army (not a fixed list)
  - Creative stat names with emojis (e.g., "Salt Generator ðŸ§‚: 9/10")
  - Descriptions explaining why each stat applies

- **Army Spirit Icon Generation API:**
  - New `POST /api/dossier/generate-spirit-icon` endpoint
  - Uses Gemini `gemini-3-pro-image-preview` for grimdark comic book style icons
  - Resizes to 256x256 PNG and uploads to Supabase Storage
  - Persists to `ArmySpiritIcon` database table with hash-based deduplication
  - Full Langfuse tracing for observability

### Changed
- **Dossier Report Streamlined:**
  - Removed redundant "Army at a Glance" section (replaced by Army Spirit)
  - Removed Tier Distribution Chart (tier info available in unit cards)
  - Removed Matchup Matrix visualization (matchup data in strategic analysis)
  - Removed Unit Competitive Profiles section (redundant with unit cards)
  - Consolidated to 9 focused sections as requested

- **Sections Retained:**
  1. Army Spirit (hero with icon, tagline, playstyle, combat focus, fun stats, meta readiness)
  2. Strengths and Weaknesses
  3. Unit Synergies (Synergy Network visualization)
  4. Strategic Assessment
  5. Unit Profiles by Role (expandable unit cards)
  6. Collection Gaps & Recommendations

- **HTML Export Major Enhancement:**
  - **Self-Contained Portability**: All images (Army Spirit icon + unit icons) are now embedded as base64 data URIs
  - **Offline Viewing**: Exported reports now work 100% offline with no external network requests
  - **Static Synergy Network**: Added a static version of the synergy visualization with role-based colors, connection badges, and tier badges
  - **Layout Parity**: Updated unit cards to include icons and role badges matching the React UI
  - **Accessibility & Contrast Fixes**: 
    - Switched to dark background/light text theme for the entire document
    - Increased contrast for labels, muted text, and metadata (replaced dark gray with readable slate/gray)
    - Darkened Strengths/Weaknesses panels for better scanability
    - Optimized font sizes and weights for small-print tabletop reference
  - **Full Viral Insights**: Included all playstyle bars, combat spectrum, and fun stats in the export layout
  - **Clean Metadata**: Standardized footer with generation timestamps and engine versioning

### Fixed
- **Gemini Schema Nesting Error:**
  - Flattened `viralInsights` schema to avoid "maximum nesting depth" API error
  - Added `parseViralInsights()` helper to restructure flat response into nested format
  - Schema now uses flat properties (e.g., `primaryPlaystyle`, `primaryPlaystylePercent`) instead of deep objects

### Technical
- New: `app/api/dossier/generate-spirit-icon/route.ts` - Icon generation with Supabase storage
- New: `ArmySpiritIcon` Prisma model for icon persistence
- Updated: `lib/dossierAnalysis.ts` - Added `ViralInsights`, `PlaystyleArchetype`, `FunStat` types, `parseViralInsights()` helper
- Updated: `app/api/dossier/analyze/route.ts` - Flattened schema, integrated `parseViralInsights()`
- Updated: `components/DossierReport.tsx` - New Army Spirit hero section, removed redundant sections
- Updated: `lib/dossierExport.ts` - HTML export with viral insights, removed legacy sections

### Database Schema Changes
- **ArmySpiritIcon (new):** Stores generated icons with `dossierHash`, `imageUrl`, `tagline`, `generatedAt`

---

## [4.50.0] - 2025-12-29 - Competitive Context UI Enhancements

### Added
- **Competitive Insights on Datasheet View:**
  - Public datasheet detail page (`/datasheets/[id]`) now displays competitive context
  - Shows tier badge (S/A/B/C/D/F with color coding), reasoning, targets, counters, synergies
  - Playstyle notes, deployment tips, and additional notes sections
  - Source count and context scope indicator (Generic/Faction/Detachment)
  - Automatic faction-scoped context lookup based on datasheet's linked faction

- **Editable Competitive Contexts in Admin:**
  - New `CompetitiveContextEditor` component in Datasheet Editor Modal
  - View/Edit toggle for each scoped context
  - Inline editing of all competitive fields (tier, reasoning, targets, counters, synergies, etc.)
  - Saves directly to `DatasheetCompetitiveContext` table via aggregate API
  - Scope badge shows faction/detachment or "Generic"

- **Admin API Enhancement:**
  - `GET /api/admin/datasheets/[id]` now includes `competitiveContexts` array
  - Returns all scoped contexts from `DatasheetCompetitiveContext` table
  - Each context includes faction/detachment names, parsed JSON arrays

### Changed
- **Datasheet Editor Modal:**
  - Removed legacy "Manual Override" section (wrote to deprecated Datasheet fields)
  - Competitive tab now displays scoped contexts with edit capability
  - Empty state message when no context exists

### Removed
- Legacy competitive context fields display in admin (now uses scoped contexts)
- Manual override form for deprecated Datasheet.competitiveTier/etc fields

### Technical
- Updated: `app/datasheets/[id]/page.tsx` - Fetches and displays competitive context with faction scope
- Updated: `app/api/admin/datasheets/[id]/route.ts` - Includes `datasheetCompetitiveContexts` in response
- Updated: `components/DatasheetEditorModal.tsx` - New `CompetitiveContextEditor` component, removed legacy form

---

## [4.49.0] - 2025-12-29 - Faction/Detachment-Specific Competitive Context

### Added
- **Faction/Detachment-Scoped Competitive Context:**
  - New `DatasheetCompetitiveContext` table stores context per `(datasheet, faction, detachment)` combination
  - Three scope levels: Generic (all armies), Faction-specific, Detachment-specific
  - Fallback lookup: detachment â†’ faction â†’ generic
  - New API endpoint `GET /api/datasheets/detail/[id]/competitive-context` with fallback logic

- **Detachment Tagging for Sources:**
  - Sources can now be tagged with a specific detachment via `detachmentId`
  - Admin UI: Detachment dropdown when adding sources to a faction
  - Detachment badge displayed on source cards
  - `PATCH /api/admin/competitive-sources/[id]` supports `detachmentId` updates

- **Batch Aggregation (`--aggregate-all`):**
  - New command: `python3 scripts/youtube_transcribe.py --aggregate-all --faction-name "Space Wolves"`
  - Automatically aggregates all datasheets with extracted context for a faction
  - Processes units one-by-one with progress reporting
  - Success/failure summary at completion

- **Langfuse Tracing for Curation:**
  - Full observability for competitive source curation pipeline
  - Traces include source metadata, datasheet counts, and AI outputs

### Changed
- **Aggregation API (`PATCH /api/admin/datasheets/[id]/aggregate`):**
  - Now accepts `factionId` and `detachmentId` for scoped context creation
  - Returns created context with scope information

- **Pipeline Script Improvements:**
  - Increased `maxOutputTokens` to 65536 for all Gemini calls (prevents truncation)
  - Increased all Gemini API timeouts to 600 seconds (10 minutes)
  - Added JSON repair logic for truncated responses
  - Concise summary instructions to reduce output size

### Fixed
- **Route Conflict:** Moved `/api/datasheets/[id]/competitive-context` to `/api/datasheets/detail/[id]/competitive-context` to avoid Next.js dynamic route conflict with `[faction]`

### Database Schema Changes
- **DatasheetCompetitiveContext (new):** Stores aggregated context with `datasheetId`, `factionId`, `detachmentId` scope
- **CompetitiveSource:** Added `detachmentId` foreign key for detachment-specific sources
- **Migration:** Existing competitive data migrated from `Datasheet` fields to `DatasheetCompetitiveContext` as generic context

### Technical
- New: `app/api/datasheets/detail/[id]/competitive-context/route.ts` - Context lookup with fallback
- Updated: `app/api/admin/datasheets/[id]/aggregate/route.ts` - Scoped context creation
- Updated: `app/api/admin/competitive-sources/[id]/route.ts` - Detachment update support
- Updated: `app/api/admin/factions/[id]/sources/route.ts` - Detachment on source creation
- Updated: `app/admin/factions/[id]/page.tsx` - Detachment selector in add source form
- Updated: `scripts/youtube_transcribe.py` - `--aggregate-all`, increased limits, JSON repair
- Updated: `prisma/schema.prisma` - New table and relations

---

## [4.48.0] - 2025-12-28 - Faction-Level Competitive Sources Pipeline

### Added
- **Faction-Level Source Management:**
  - Sources are now added at the faction level (not per-datasheet)
  - New "ðŸ“š Competitive Sources" section on Faction Admin page (`/admin/factions/[id]`)
  - Sources can cover multiple units - AI identifies and links relevant datasheets
  - Status tracking through pipeline stages: `pending` â†’ `fetched` â†’ `curated` â†’ `extracted`

- **Multi-Stage Processing Pipeline:**
  - `--fetch-pending`: Downloads content from YouTube, Reddit, articles, and forums
  - `--curate-pending`: AI identifies mentioned units and creates DatasheetSource links
  - `--extract-pending`: AI extracts unit-specific context for each linked datasheet
  - `--aggregate --datasheet-name "Name"`: Synthesizes all sources into final competitive context
  - `--process-all`: Runs fetch â†’ curate â†’ extract in sequence

- **Multi-Source Type Support:**
  - YouTube: Transcripts via yt-dlp with caption/Whisper fallback
  - Reddit: JSON API scraping for posts and comments
  - Articles/Blogs: Clean HTML extraction via BeautifulSoup
  - Forums: Thread content extraction

- **Competitive Context Aggregation:**
  - Synthesizes insights from ALL extracted sources for a datasheet
  - Updates datasheet fields: `competitiveTier`, `tierReasoning`, `bestTargets`, `counters`, `synergies`, `playstyleNotes`, `deploymentTips`, `competitiveNotes`
  - Conflict detection when sources disagree on rankings

- **Enhanced Datasheet Editor Modal:**
  - Modal now fetches fresh data from API when opened (ensures competitive fields load)
  - Loading state with spinner during data fetch
  - "Linked Sources" section shows sources with extraction status
  - Read-only source viewing (add sources via Faction page)

### Changed
- **Data Model Refactored:**
  - `CompetitiveSource` now has `factionId` for faction-level attachment
  - `CompetitiveSource.transcript` renamed to `content` (generic for all source types)
  - `CompetitiveSource.status` tracks pipeline stage
  - `DatasheetSource` is now a junction table linking sources to datasheets
  - Added `mentionedUnitsJson` field for AI curation results

- **Admin Datasheets API:**
  - List endpoint now includes competitive context fields (`competitiveTier`, `tierReasoning`, etc.)
  - JSON array fields parsed in response (`bestTargets`, `counters`, `synergies`)

- **Python Script Architecture:**
  - Refactored from single-datasheet processing to faction-wide pipeline
  - API key authentication via `ADMIN_API_KEY` environment variable
  - New endpoints for each pipeline stage

### Fixed
- **Status Mismatch:** Changed status value from `"processed"` to `"extracted"` for consistency
- **Modal Data Loading:** Fixed competitive fields not showing by fetching fresh data on modal open
- **Reddit Scraping:** Fixed `old.old.reddit.com` SSL error and 403 blocks using JSON endpoint

### Technical
- New: `app/api/admin/factions/[id]/sources/route.ts` - Faction source management
- New: `app/api/admin/competitive-sources/pending/route.ts` - Pipeline fetch endpoint
- New: `app/api/admin/competitive-sources/[id]/route.ts` - Source update endpoint
- New: `app/api/admin/competitive-sources/[id]/datasheet-links/route.ts` - Curation links
- New: `app/api/admin/datasheet-sources/[id]/extract/route.ts` - Extraction update
- Updated: `app/api/admin/datasheets/route.ts` - Added competitive fields to list
- Updated: `app/api/admin/datasheets/[id]/aggregate/route.ts` - Aggregation endpoint
- Updated: `components/DatasheetEditorModal.tsx` - Fresh data fetch, loading state
- Updated: `scripts/youtube_transcribe.py` - Full pipeline implementation
- Updated: `prisma/schema.prisma` - Faction-level source model

### Database Schema Changes
- `CompetitiveSource`: Added `factionId`, `content`, `status`, `mentionedUnitsJson`
- `DatasheetSource`: Now junction table with `competitiveSourceId`, `relevanceScore`, `mentionCount`
- `Datasheet`: Added `contextLastAggregated`, `contextSourceCount`, `contextConflicts`

---

## [4.47.0] - 2025-12-27 - Competitive Context Database Extension & Offline Fetching

### Added
- **DatasheetSource Model**: Extended Prisma schema with a new table to track individual YouTube/article sources per datasheet, enabling a many-to-many relationship between datasheets and competitive insights.
- **Datasheet Source Management API**:
  - `GET/POST /api/admin/datasheet-sources`: List and add sources with status tracking.
  - `GET/PATCH/DELETE /api/admin/datasheet-sources/[id]`: Complete management of individual sources including transcript and extracted context.
  - `GET /api/admin/datasheet-sources/pending`: Dedicated endpoint for offline processing scripts to fetch unprocessed items.
  - `POST /api/admin/datasheet-sources/bulk-update`: High-performance batch update endpoint for saving script results.
- **Admin UI - Competitive Context Dashboard**:
  - New management interface at `/admin/competitive-context`.
  - Advanced datasheet search/filter system (faction, role, name) for quick source assignment.
  - Visual status dashboard for tracking pending, fetched, processed, and error states.
  - Modal views for reviewing extracted AI context and raw transcripts.
- **Python Script - Offline Processing Mode**:
  - Enhanced `scripts/youtube_transcribe.py` with `--fetch-pending` flag for automated batch processing.
  - Integrated transcript fetching (captions/Whisper) with Gemini-3-Flash context extraction.
  - Automatic database synchronization via the new bulk-update API.

### Technical
- Updated: `prisma/schema.prisma` - Added `DatasheetSource` table and relations.
- New: `app/api/admin/datasheet-sources/route.ts` - Main CRUD endpoint.
- New: `app/api/admin/datasheet-sources/[id]/route.ts` - Single source management.
- New: `app/api/admin/datasheet-sources/pending/route.ts` - Batch processing fetch.
- New: `app/api/admin/datasheet-sources/bulk-update/route.ts` - Batch processing save.
- New: `app/admin/competitive-context/page.tsx` - Admin management dashboard.
- Updated: `scripts/youtube_transcribe.py` - Added batch processing and API integration.

---

## [4.46.0] - 2025-12-27 - Competitive Context Paste Feature & Model Upgrade

### Added
- **Competitive Context Paste Workflow**:
  - Replaced unreliable Node.js YouTube transcript fetching with a robust manual paste workflow.
  - New "Add Competitive Source" form in admin UI allowing manual input of transcripts, titles, and metadata.
  - Guided instructions for running the provided local Python script to fetch transcripts reliably using `yt-dlp`.
  - Structured output support for pasted text, converting raw transcripts into categorized unit and faction insights.

- **New API Endpoint (`POST /api/competitive/create-from-text`)**:
  - Technical endpoint to create `CompetitiveSource` records from manually provided text.
  - Supports YouTube, articles, notes, and other source types.
  - Generates unique identifiers for non-YouTube sources to maintain database integrity.

- **Model Upgrade to Gemini 3 Flash**:
  - Upgraded all competitive context parsing endpoints to `gemini-3-flash-preview`.
  - Standardized call patterns to match the high-performance `/analyze` endpoint.
  - Implemented noise-tolerant prompting to handle messy auto-transcripts with heavy repetition and phonetic misspellings (e.g., "Adra Eggatone" -> "Adrax Agatone").

### Changed
- **Removed Unreliable Node.js Dependencies**:
  - Deleted `lib/youtubeTranscript.ts`, `lib/whisperTranscribe.ts`, and `lib/youtubeCaptions.ts`.
  - Removed `app/api/competitive/fetch-transcript/route.ts`.
  - Simplified the codebase by removing ~1,000 lines of flaky third-party YouTube API interaction code.
- **Limitless Context**: Removed character limits (previously 30k-60k) for competitive context parsing, allowing full transcripts (up to 500k chars) to be processed in a single AI call.

### Technical
- Updated: `app/admin/competitive-context/page.tsx` - New paste-based admin UI
- New: `app/api/competitive/create-from-text/route.ts` - Manual text source creation endpoint
- Updated: `app/api/competitive/parse-from-text/route.ts` - Upgraded to Gemini 3 Flash, added noise tolerance
- Updated: `app/api/competitive/parse-for-unit/route.ts` - Upgraded to Gemini 3 Flash, added noise tolerance, increased context limit
- Updated: `lib/competitiveContextParser.ts` - Upgraded to Gemini 3 Flash, increased context/chunk limits
- Updated: `scripts/youtube_transcribe.py` - Added `--json` flag for easy metadata copy-paste

---

## [4.45.0] - 2025-12-25 - Dossier Analysis Improvements

### Removed
- **Radar Chart from Dossier**: Removed the "Army Profile" radar chart visualization from both the UI (`DossierReport.tsx`) and HTML export (`dossierExport.ts`) as it provided limited actionable value compared to the role-based analysis and AI insights.

### Changed
- **Removed `maxOutputTokens` Limit**: Removed the 30,000 token output limit from Gemini API configuration, allowing the model to use its default maximum for more comprehensive strategic analysis responses.
- **Simplified Gemini Config**: Removed `thinkingConfig` with `thinkingBudget: 0` to prevent issues with token allocation between thinking and output.

### Added
- **Response Truncation Detection**: Added pre-parse validation to detect truncated Gemini responses before JSON parsing. If truncation is detected (response doesn't end with `}` or `]`), returns a clear error message indicating the response was too long rather than a cryptic JSON parse error.

### Fixed
- **JSON Parse Errors**: Fixed `SyntaxError: Unterminated string in JSON` errors caused by truncated AI responses hitting the previous 30,000 token output limit.

### Technical
- Updated: `app/api/dossier/analyze/route.ts` - Removed maxOutputTokens, added truncation detection
- Updated: `components/DossierReport.tsx` - Removed radar chart section and import
- Updated: `lib/dossierExport.ts` - Removed Chart.js CDN, radar chart HTML, and related CSS

---

## [4.44.0] - 2025-12-25 - AI Strategic Dossier Analysis

### Added
- **AI Strategic Analysis for Dossier** (`POST /api/dossier/analyze`):
  - Gemini 3 Flash integration for high-level army list strategic insights
  - Structured JSON output with executive summary, army archetype classification
  - Statistical breakdown: unit counts, wounds, toughness distribution, damage profiles
  - Strategic strengths and weaknesses identification with severity ratings
  - Matchup considerations vs common army archetypes (horde, elite, gunline, etc.)
  - Secondary objective recommendations (strong picks, avoid picks, scoring potential)
  - Collection recommendations with priority ratings and alternatives
  - Threat assessment with peak threat phase and counter-strategies

- **Enhanced Capability Detection:**
  - Deep Strike detection via keywords (TERMINATOR, JUMP PACK, TELEPORT HOMER, DAEMON)
  - Scout/Infiltrate detection via keywords (PHOBOS, SCOUTS, INFILTRATORS)
  - FLY keyword detection for mobility assessment
  - Unit-specific ability scanning for deployment options

- **Langfuse Observability:**
  - Full trace integration for dossier analysis requests
  - Context building spans with unit/capability metadata
  - Generation tracking with model, temperature, and response metrics
  - Tags for faction, archetype, and threat level filtering

### Fixed
- **Deep Strike/Infiltrate Detection:** Units with TERMINATOR, JUMP PACK, PHOBOS keywords now correctly detected as having deployment capabilities (previously only checked literal "DEEP STRIKE" keyword)
- **NaN Prevention:** Added `safeNumber()` helper to all numerical calculations preventing NaN propagation in damage outputs, radar scores, and statistical breakdowns

### Technical
- New: `app/api/dossier/analyze/route.ts` - AI strategic analysis endpoint with structured outputs
- Updated: `lib/dossierAnalysis.ts` - Added context builders, prompt generators, and NaN safety
- Updated: `components/DossierReport.tsx` - Integrated AI strategic insights display
- Updated: `app/dossier/page.tsx` - Added AI analysis state and API call flow
- New types: `DossierStrategicAnalysis`, `DossierContext` interfaces
- Documentation: Updated [Tactical Dossier](docs/features/TACTICAL_DOSSIER.md)
- Documentation: New [Dossier Analyze Endpoint](docs/api/DOSSIER_ANALYZE_ENDPOINT.md)

---

## [4.43.0] - 2025-12-24 - Tactical Dossier (War Room) Feature

### Added
- **Tactical Dossier Page** (`/dossier`):
  - New standalone page for army list analysis and report generation
  - Accepts text paste, image upload, or PDF upload via existing parser
  - Three-pillar analysis engine: MathHammer, Meta Context, Objective Ecology
  - Chart.js radar chart with 5 axes: Killing Power, Durability, Mobility, Board Control, Flexibility
  - Complete threat assessment with strengths/weaknesses identification
  - Collection gaps detection with actionable recommendations
  - Key stratagems reminder section
  - Unit-by-unit breakdown table with damage output and durability tiers

- **HTML Export**:
  - Self-contained HTML file generation for sharing
  - Inline CSS with taclog theme styling
  - Chart.js CDN for radar chart visualization
  - Complete analysis data embedded in exportable document
  - One-click download as `tactical-dossier-{faction}-{date}.html`

### Technical
- Created `lib/dossierAnalysis.ts` - Core analysis engine with damage calculations
- Created `lib/dossierExport.ts` - HTML export generator with inline styles
- Created `components/DossierRadarChart.tsx` - Chart.js radar visualization
- Created `components/DossierReport.tsx` - Full report display component
- Created `app/dossier/page.tsx` - Main dossier page with input form
- Added `chart.js` and `react-chartjs-2` dependencies

---

## [4.42.2] - 2025-12-21 - Tactical Map Bottom Sheet Refactor

### Changed
- **Tactical Map Modal:**
  - Converted from a full-screen black overlay to the standardized bottom sheet pattern.
  - New slide-up animation with semi-transparent blurred backdrop.
  - Light slate header matching other system modals (`bg-taclog-slate-dark`).
  - Added a dedicated drag handle and standardized close button.
  - Legend moved to a prominent footer with consistent player coloring.
  - Integrated round indicators directly into the modal header for better context.

### Technical
- Created `ObjectiveMapModal.tsx` to encapsulate bottom sheet logic.
- Refactored `TacticalMapView.tsx` to support an `isModal` mode for adaptive layout.
- Integrated `ObjectiveMapModal` into `GameStateDisplay.tsx` using React Portals.
- Streamlined objective update callbacks and state synchronization.

---

## [4.42.1] - 2025-12-21 - Round/Phase Controls Light Grimdark Redesign

### Changed
  - **Round/Turn + Phase Controls (iPad-first):**
    - Light-slate control surfaces with neutral backgrounds (no attacker/defender tint)
    - Turn indication:
      - Round/Turn: **ATTACKER/DEFENDER labels** (red/green backgrounds with white text)
      - Phase: subtle **turn-colored marker** near the chevron (no chip)
    - **Visual "Pop" for Game State:**
      - Phase names ("Command", "Movement", etc.) highlighted in **TacLog Orange**
      - Round numbers highlighted in **TacLog Orange**
      - Increased font sizes for primary values (`sm:text-base`)
    - **Improved Mobile UX:**
      - **Large tap targets:** Dropdown items increased to ~48px height (`py-3`)
      - Removed truncation so **round + phase context is always visible** (wraps instead of ellipses)
    - Added **inline SVG visual aids** (gladius/shield for turn, per-phase icons)
    - Removed time/clock icon to free up horizontal space
    - Removed "(1st)/(2nd)" turn order text (redundant with ATT/DEF)
    - Dropdown menus restyled to match the lighter grimdark header theme
    - Compact 44px height optimized for iPad/mobile thumb targets

### Technical
- Created `components/ControlIcons.tsx` with reusable SVG icon set
- Updated `RoundTurnSelector` and `PhaseControl` components with new styling system
- Responsive width handling (full-width on mobile, fixed on tablet+)

---

## [4.42.0] - 2025-12-22 - Event Log Unit Icons with Action Indicators

### Added
- **Event Log Unit Icons:**
  - Unit icons displayed inline with event descriptions (48x48px)
  - Custom uploaded icons supported with fallback to role-based emojis
  - Batch icon resolution for efficient loading
  - Colored borders indicate action category (red=damage, amber=stratagem, purple=action, blue=status)
  - Badge overlays show specific details (models killed, CP cost, action type)
  - Visual indicators for damage (-1, -2, ðŸ’€), stratagems (-1 CP, -2 CP), actions (â†“, âš”, â†’), and status (âš¡, â—ˆ)

### Technical
- Added `attackerFaction`/`defenderFaction` props to Timeline component
- Created `extractUnitInfoFromEvent()` helper for metadata parsing
- Created `getActionCategoryFromEvent()` helper for action categorization
- Integrated `useUnitIcons` hook for batch icon fetching
- Enhanced event rendering with contextual visual indicators

---

## [4.41.0] - 2025-12-22 - Unit Health Sync & Combat Damage Consolidation

### Fixed
- **Unit Health Sync Issues:**
  - Fixed critical bug where `modelsArray` didn't match `currentModels` count
  - Units initialized from `compositionData` templates now correctly scale to actual model count
  - Added runtime reconciliation in `updateUnitHealth` to sync modelsArray before applying damage
  - Fixed UI not refreshing after tool calls - UnitHealthSheet now updates immediately after analyze endpoint

- **Combat Damage Tracking:**
  - Merged `log_combat_result` functionality into `update_unit_health` tool
  - Added combat context parameters (`attacking_unit`, `attacking_player`, `combat_phase`) to `update_unit_health`
  - CombatLog entries now created automatically when combat context is provided
  - Deprecated standalone `log_combat_result` tool (handler kept for backwards compatibility)

### Added
- **Damage Validation:**
  - Added `validateDamageInput()` function to catch impossible inputs (e.g., killing more models than exist)
  - Validation warnings for suspicious overkill scenarios (trusts player input but flags potential issues)
  - Better error messages when unit state is invalid

- **UI Refresh Mechanism:**
  - Added `unitsRefreshKey` state to force UnitHealthSheet remount after tool calls
  - Cache invalidation for units endpoint after game state refresh
  - Ensures UI always shows latest unit health after voice commands

### Changed
- **Intent Orchestration:**
  - `COMBAT_LOGGING` intent now maps to `update_unit_health` with combat context
  - Updated context tier from `unit_names` to `units_only` (needs full unit health for accurate damage)
  - Updated AI prompts with damage overkill awareness (excess damage doesn't spill between models)

### Technical
- Fixed unit initialization in `app/api/sessions/route.ts` and `app/api/sessions/[id]/units/route.ts`
- Added modelsArray sync validation in `lib/toolHandlers.ts` before damage application
- Enhanced `refreshGameState()` to invalidate units cache and trigger UI refresh

---

## [4.40.0] - 2025-12-21 - Warhammer 40K Vocabulary Recognition

### Added
- **Phonetic Correction System:**
  - New `lib/warhammerCorrections.ts` with 200+ phonetic corrections for Warhammer 40K terms
  - Automatic client-side correction of common speech-to-text errors before server processing
  - Session-specific vocabulary support for runtime term additions
  
- **Vocabulary Generation Script:**
  - New `scripts/generateVocabulary.ts` extracts terms from Wahapedia import data
  - Generates `lib/generatedVocabulary.ts` with 1,971 terms and 687 phonetic variations
  - Supports re-generation when faction data is updated
  
- **Dynamic AI Context Hints:**
  - Enhanced `lib/contextBuilder.ts` with session-aware phonetic hints
  - AI prompts now include unit-specific pronunciation guidance
  - Improved common error examples (e.g., "oath of movement" â†’ "Oath of Moment")

### Changed
- **Speech Recognition Integration:**
  - `lib/speechRecognition.ts` now applies corrections to both interim and final transcripts
  - Corrections logged for debugging when applied
  - Real-time display shows corrected terms as user speaks

### Technical
- Corrections flow: Web Speech API â†’ `applyAllCorrections()` â†’ Server
- Phrase-level matching (longer phrases first to avoid partial matches)
- Case-insensitive regex replacement preserves original casing intent
- Zero latency impact - corrections applied synchronously before emit

### Examples of Fixed Transcriptions
| Misheard | Corrected |
|----------|-----------|
| "term against" | "Termagants" |
| "tyranno flex" | "Tyrannofex" |
| "intercesses" | "Intercessors" |
| "oath of movement" | "Oath of Moment" |
| "strata gems" | "Stratagems" |

---

## [4.39.2] - 2025-12-20 - Speech Analysis Debounce & Context Capture Fix

### Fixed
- **Speech Analysis Race Condition:**
  - Fixed issue where partial speech was analyzed instead of complete sentences
  - User pausing mid-sentence no longer triggers premature analysis
  - Newer speech now correctly supersedes older in-flight requests

### Added
- **Hybrid Debounce + Abort Controller System:**
  - 500ms debounce buffer accumulates transcripts before sending to AI
  - AbortController cancels in-flight requests when new speech arrives
  - Complete context sent in single request instead of fragmented partial requests

### Technical
- `app/page.tsx`:
  - Added `analyzeAbortControllerRef` for request cancellation
  - Added `pendingTranscriptsRef` for transcript accumulation
  - Added `analyzeDebounceTimeoutRef` with 500ms delay
  - Refactored `handleFinalTranscript` to buffer + debounce pattern
  - New `sendAccumulatedTranscripts` function handles actual API calls
  
- `lib/speechRecognition.ts`:
  - Reduced internal flush timeout from 1200ms to 1000ms (frontend handles additional buffering)
  
- `lib/requestDeduplication.ts`:
  - Changed from blocking newer requests to allowing supersession
  - Older requests cleaned up when newer ones arrive
  - Frontend AbortController handles HTTP abort

### Data Flow
```
User speaks â†’ Speech API â†’ Flush (1000ms) â†’ Debounce Buffer (500ms)
                                                    â†“
                                           Abort previous if in-flight
                                                    â†“
                                           Send accumulated context to /api/analyze
```

---

## [4.39.1] - 2025-12-20 - Stratagem Modal Pre-fetch Optimization

### Changed
- **Stratagem Modal Performance Optimization:**
  - Stratagems are now pre-fetched when the session loads (not on modal open)
  - Modal opens instantly with no loading state
  - Phase/turn changes re-compute availability client-side (no API calls)
  - "Show only available" is now checked by default

### Technical
- `GameStateDisplay.tsx`:
  - Added `CachedStratagem` and `StratagemCache` interfaces
  - Pre-fetches both attacker and defender stratagems on session load
  - Added `computeAvailability()` for client-side phase/turn filtering
  - Added `computedStratagems` memoized value that updates on phase/turn changes
  
- `StratagemReferenceModal.tsx`:
  - Removed `sessionId` prop and all fetch logic
  - Now accepts pre-computed `coreStratagems` and `factionStratagems` via props
  - Removed loading/error states (data is always available)
  - Changed `showOnlyAvailable` default from `false` to `true`

### Data Flow
```
Session Load â†’ Pre-fetch stratagems â†’ Cache in state
Phase/Turn Change â†’ Client-side availability computation â†’ Update modal
Modal Open â†’ Instant display (no network request)
```

---

## [4.39.0] - 2025-12-20 - Modal Bottom Sheet Standardization

### Changed
- **Complete Modal UI Standardization:**
  - Converted 20 modals to consistent bottom sheet pattern matching `UnitHealthSheet.tsx`
  - New slide-up animation from bottom of screen
  - Rounded top corners (`rounded-t-xl` or `rounded-t-2xl`)
  - Light slate theme (`bg-taclog-slate-light`) replacing dark backgrounds
  - Semi-transparent backdrop with blur (`bg-taclog-black/45 backdrop-blur-[2px]`)
  - Consistent z-index (`z-[60]`) for proper layering
  - Neutral styling with `text-taclog-black` for headers and content
  - Updated buttons with proper contrast for light backgrounds

### Modals Updated
- `ConfirmDialog.tsx` - Confirmation dialogs
- `SettingsModal.tsx` - App settings
- `StratagemReferenceModal.tsx` - Stratagem quick reference (removed player-specific colors)
- `TacticalAdvisorModal.tsx` - AI tactical advice
- `MissionSelectionModal.tsx` - Mission selection
- `AddUnitModal.tsx` - Add units to battle
- `SecondarySelectionModal.tsx` - Secondary objective selection
- `SecondaryDetailModal.tsx` - Secondary objective details
- `TacticsModal.tsx` - Tactics overview
- `BattleReadyModal.tsx` - Battle ready configuration
- `ShareModal.tsx` - Share functionality
- `AuthModal.tsx` - Authentication
- `StratagemLoggerModal.tsx` - Manual stratagem logging
- `ModelDetailsModal.tsx` - Model detail view
- `StrategicAssistantModal.tsx` - Strategic assistant (deprecated)
- `DamageResultsModal.tsx` - Damage calculation results
- `RevertConfirmDialog.tsx` - Revert confirmation
- `DatasheetEditorModal.tsx` - Datasheet editing
- `tools/DamageCalculatorModal.tsx` - MathHammer calculator
- `tools/IconGeneratorModal.tsx` - Icon generation

### Design Pattern
```tsx
// Standard bottom sheet structure
<div className="fixed inset-0 z-[60] flex flex-col justify-end">
  {/* Backdrop */}
  <div className="absolute inset-0 bg-taclog-black/45 backdrop-blur-[2px]" onClick={onClose} />
  
  {/* Bottom Sheet */}
  <div className="relative bg-taclog-slate-light border-t-2 border-taclog-steel rounded-t-xl shadow-lg animate-slide-up">
    {/* Header */}
    <div className="bg-taclog-slate-light border-b border-taclog-steel">
      <h2 className="text-taclog-black font-bold">Title</h2>
    </div>
    
    {/* Content */}
    <div className="bg-taclog-slate-light">...</div>
    
    {/* Footer */}
    <div className="bg-taclog-slate-light border-t border-taclog-steel">...</div>
  </div>
</div>
```

### Technical
- Updated: All 20 modal components with consistent bottom sheet pattern
- Removed: Player-specific color theming from `StratagemReferenceModal.tsx`
- Enhanced: Form inputs and buttons with proper light theme contrast
- Documentation: New [Modal Standardization](docs/features/MODAL_STANDARDIZATION.md)

---

## [4.38.1] - 2025-12-21 - Defender Army Linking & Detachment Filtering

### Added
- **Defender Army Linking:**
  - New `defenderArmyId` column in GameSession for full defender army data access
  - Sessions now store linked defender army for detachment, faction, and unit access
  - Enables future features requiring defender army details

- **Core Stratagems Database Seeding:**
  - All 11 core stratagems seeded to CoreStratagem table
  - Includes: Command Re-roll, Fire Overwatch, Go to Ground, Counter-offensive, Epic Challenge, Grenade, Heroic Intervention, Insane Bravery, Rapid Ingress, Smokescreen, Tank Shock

### Fixed
- **Detachment-Specific Stratagem Filtering:**
  - Stratagems now correctly filter by the player's selected detachment
  - Defender stratagems filter to their army's detachment (e.g., "Forgefather's Seekers" shows only those 6 stratagems)
  - Prevents duplicate stratagems from appearing (was showing all detachment variants)

- **Text Contrast in Stratagem Modal:**
  - Changed from dark backgrounds with dark text to white cards with dark text
  - Expanded sections use light background for readability

### Technical
- Migration: Added `defenderArmyId` column to GameSession with foreign key to Army
- Updated: `prisma/schema.prisma` - Added DefenderArmy relation with named relations
- Updated: `app/api/sessions/route.ts` - Now stores defenderArmyId when creating sessions
- Updated: `app/api/sessions/[id]/stratagems/route.ts` - Uses defender army's detachment for filtering
- Updated: `components/StratagemReferenceModal.tsx` - Improved text contrast and card styling

---

## [4.38.0] - 2025-12-20 - Stratagem Quick Reference

### Added
- **Stratagem Quick Reference Modal:**
  - New `STRATAGEMS` button in defender and attacker panels
  - Phase-filtered stratagem display showing available stratagems for current game phase
  - Displays both Core stratagems and Faction/Detachment stratagems
  - Expandable cards with full stratagem details (when, target, effect)
  - Reactive stratagems highlighted when it's opponent's turn
  - "Show only available" filter toggle
  - CP affordability indicators
  - Read-only reference mode (no logging action)

- **Session Stratagems API Endpoint:**
  - New `GET /api/sessions/[id]/stratagems` endpoint
  - Query parameters: `phase`, `turn`, `player`
  - Returns core + faction stratagems filtered by phase
  - Handles Space Marines subfactions (loads parent faction stratagems too)
  - Sorts stratagems by availability, then CP cost

### Technical
- New: `app/api/sessions/[id]/stratagems/route.ts` - Stratagem fetching with phase filtering
- New: `components/StratagemReferenceModal.tsx` - Modal with expandable stratagem cards
- Updated: `components/GameStateDisplay.tsx` - Added stratagem buttons and modal integration
- Documentation: New [Stratagem Quick Reference](docs/features/STRATAGEM_QUICK_REFERENCE.md)
- Documentation: New [Session Stratagems Endpoint](docs/api/SESSION_STRATAGEMS_ENDPOINT.md)

---

## [4.37.0] - 2025-12-20 - Icon Generation Improvements

### Added
- **Icon Delete Functionality:**
  - New `DELETE /api/admin/icons/delete` endpoint removes icons from Supabase Storage and database
  - Delete button appears on units that have icons in the admin panel
  - Confirmation dialog before deletion

- **Cache Busting for Icon Updates:**
  - Icon URLs now include `?v={timestamp}` query parameter based on `updatedAt`
  - Regenerated icons display immediately without browser cache issues
  - Applied to both status endpoint and resolve endpoint (single + batch)

### Changed
- **Icon Generation Prompt Overhaul:**
  - Switched from anime style to bold comic book illustration style
  - New framing: waist/hip up crop to capture weapon and armor profiles
  - Removed conflicting border instructions that caused red circle artifacts
  - High contrast cel-shading with strong ink outlines for icon clarity
  - Optimized for instant recognition at small sizes (iPad icons)

### Technical
- Updated: `app/api/admin/icons/generate/route.ts` - New comic book style prompt
- Updated: `app/api/admin/icons/status/route.ts` - Cache busting with updatedAt
- Updated: `app/api/icons/resolve/route.ts` - Cache busting for single and batch lookups
- Updated: `app/admin/icons/page.tsx` - Delete button and cache-busted icon URLs
- New: `app/api/admin/icons/delete/route.ts` - Icon deletion endpoint
- Documentation: Updated [Unit Icon Generation](docs/features/UNIT_ICON_GENERATION.md)
- Documentation: New [Admin Icons Delete Endpoint](docs/api/ADMIN_ICONS_DELETE_ENDPOINT.md)

---

## [4.36.1] - 2025-01-19 - Langfuse Tracing for All LLM Endpoints

### Added
- **Complete Langfuse observability for Tactical Advisor:**
  - Request-level traces with userId, sessionId, perspective, detailLevel
  - Context building spans with unit counts and stratagem data
  - Generation tracking for Gemini calls with full prompt/response
  - Game state metadata (phase, round, turn, CP, VP, objectives)
  - Tags for filtering: `tactical-advisor`, `perspective-{type}`, `detail-{level}`

- **Langfuse tracing for Admin Icon Generation:**
  - Admin request traces with userId, unitName, faction
  - Spans for image fetch, processing, upload, and database operations
  - Generation tracking for Gemini image calls
  - Tags: `admin`, `icon-generation`, `faction-{name}`

### Technical
- Updated: `app/api/tactical-advisor/route.ts` - Full Langfuse integration
- Updated: `app/api/admin/icons/generate/route.ts` - Full Langfuse integration
- Updated: `docs/features/LANGFUSE_OBSERVABILITY.md` - Documented all traced endpoints

---

## [4.36.0] - 2025-01-18 - AI Tactical Advisor

### Added
- **AI-Powered Tactical Advisor:**
  - Complete rework of Strategic Assistant into dynamic AI-powered tactical advisor
  - Uses Gemini 3 Flash to analyze live game state and generate contextual suggestions
  - Dual perspective toggle (Your Army / Opponent) for opportunities and threats
  - Two detail levels: Quick Tips (3-5 concise) or Detailed Analysis (5-10 in-depth)
  - Priority-based suggestions (High/Medium/Low) with color-coded cards
  - Category classification (Ability, Stratagem, Movement, Objective, Threat, Resources)
  - Context-aware analysis considering unit health, CP, objectives, recent stratagems
  - Suggestion UI styled like Event Log rows (light slate content area + white rows) for faster scanning
  - Quick Tips now include unit icon strips (resolved via the unit icon system) and show primary mission info when available
  - Keyboard shortcut: `Shift+S` to open/close modal

### Changed
- **Strategic Assistant â†’ Tactical Advisor:**
  - Replaced static rules filtering with dynamic AI analysis
  - New modal design matching other pop-up modals (Unit List, etc.)
  - Removed old Strategic Assistant components and API endpoints

### Technical
- New: `lib/tacticalAdvisor.ts` - Core context builder and prompt engineering
- New: `app/api/tactical-advisor/route.ts` - API endpoint with Gemini 3 Flash integration
- New: `components/TacticalAdvisorModal.tsx` - UI component with toggles and suggestion cards
- Updated: `lib/types.ts` - Added `TacticalAdviceResponse` and `TacticalSuggestion` types
- Updated: `app/page.tsx` - Integrated new Tactical Advisor modal
- Updated: `components/HamburgerMenu.tsx` - Replaced Strategic Assistant button with Tactical Advisor

### Documentation
- New: `docs/features/TACTICAL_ADVISOR.md` - Complete feature documentation
- New: `docs/api/TACTICAL_ADVISOR_API.md` - API endpoint reference

---

## [4.35.0] - 2025-12-18 - Gemini 3 Flash Support for Army Import

### Added
- **Gemini 3 Flash provider option for army parsing:**
  - Added `ARMY_PARSE_PROVIDER` environment variable to switch between OpenAI and Google Gemini
  - New `getArmyParseProvider()` and `getArmyParseModel()` functions in `lib/aiProvider.ts`
  - Gemini 3 Flash (`gemini-3-flash-preview`) integration with structured outputs
  - Uses `thinkingLevel: 'low'` for fast structured parsing
  - Supports both text and image input formats

### Changed
- Army parse endpoint (`/api/armies/parse`) now supports dual-provider architecture
- Provider selection via `ARMY_PARSE_PROVIDER` env var (defaults to `openai`)

### Technical
- Updated: `lib/aiProvider.ts` - Added army parse provider functions
- Updated: `app/api/armies/parse/route.ts` - Added Gemini 3 Flash pathway with proper content handling

---

## [4.32.4] - 2025-12-18 - Unit Health Sheet & Per-Model Mixed Wounds UX

### Added
- **Unit Health Sheet (bottom sheet):**
  - Replaced full-page unit health UI with a mobile-first, iPad-optimized bottom sheet
  - Attacker/Defender tabs with always-visible army strength summary
  - Dense unit grid with generated unit icons (datasheet-linked)
- **Per-model mixed wounds tooling:**
  - Individual Models redesigned into a responsive grid
  - Per-model **MAX WOUNDS** controls for loadout-dependent profiles (e.g., relic shields)
  - **Sync Models** repair action for legacy/partial `modelsArray` data mismatches
- **API support for advanced per-model persistence:**
  - Unit PATCH now supports `modelsArray` override + optional `startingWounds` / `woundsPerModel`

### Changed
- `GET /api/sessions/[id]/units` includes `faction` to support icon resolution.
- Battle screen opens unit management via the âš” Unit Health FAB.

### Fixed
- Per-model update indexing bug caused by filtering/renumbering displayed models.
- Mixed-wound display issues when `currentModels` and `modelsArray.length` diverged.

### Technical
- New/Updated: `components/UnitHealthSheet.tsx`
- Updated: `app/page.tsx`
- Updated: `app/api/sessions/[id]/units/route.ts`
- Updated: `app/api/sessions/[id]/units/[unitId]/route.ts`
- Updated: `lib/hooks/useUnits.ts`

---

## [4.34.0] - 2025-01-27 - Secondary Objectives Modal Consolidation & UX Improvements

### Changed
- **Secondary Objectives Modal Consolidation:**
  - Created unified `SecondaryDetailModal` component combining scoring and detail view
  - Created `SecondarySelectionModal` component for compact secondary selection (bottom-sheet style)
  - Simplified `SecondaryMiniCard` - removed inline expanded modal, now triggers detail modal directly
  - Updated `SecondaryModal` to use `SecondaryDetailModal` instead of `ScoringBottomSheet`
  - Deleted `ScoringBottomSheet` component (functionality merged into `SecondaryDetailModal`)
  - Consistent modal experience whether accessing from mini cards or full modal

- **Improved Text Contrast & Readability:**
  - Updated modal headers with lighter muted backgrounds (`#d4918f` red, `#a8c4a8` green) for better text contrast
  - Changed all header text to `text-gray-900` (near-black) for maximum readability
  - Updated scoring buttons to white backgrounds with dark text
  - Improved badge contrast with proper shadows and backgrounds
  - All text now meets WCAG accessibility standards

- **VP Display Simplification:**
  - Removed "/20" display from all VP indicators - now only shows current VP when > 0
  - Simplified `SecondaryMiniCard` VP display - removed complex progress ring, shows simple badge
  - Updated `SecondaryCardLarge` to show only current VP, no max VP display
  - Cleaner, more compact header design in detail modal

- **Mobile-First Modal Design:**
  - Both `SecondaryDetailModal` and `SecondarySelectionModal` use bottom-sheet style on mobile
  - Slide-up animation on mobile, centered modal on tablet/desktop
  - Responsive sizing optimized for iPad (`md:max-w-xl`)
  - Drag handle indicator on mobile for better UX

### Fixed
- **Secondary Scoring Refresh:**
  - Fixed `handleScoreSecondary` to refresh game state AFTER API call completes (not before)
  - Added cache invalidation before refresh to ensure fresh data
  - UI now properly updates immediately after scoring

- **Secondary Scoring Undo:**
  - Fixed undo functionality to refetch latest session data before updating secondary progress
  - Improved undo API route to handle cascade mode correctly
  - Added proper await/refresh flow in Timeline component after undo
  - Secondary progress now correctly reverts when undoing VP scoring events

### Technical
- Updated: `components/SecondaryDetailModal.tsx` - New unified modal for scoring and viewing
- Updated: `components/SecondarySelectionModal.tsx` - New compact selection modal
- Updated: `components/SecondaryMiniCard.tsx` - Simplified, removed inline modal
- Updated: `components/SecondaryModal.tsx` - Uses new detail modal
- Updated: `components/SecondaryCardLarge.tsx` - Simplified VP display, improved contrast
- Updated: `components/GameStateDisplay.tsx` - Integrated new modals, added selection modal state
- Updated: `app/page.tsx` - Fixed refresh order, added `onAddSecondary` handler
- Deleted: `components/ScoringBottomSheet.tsx` - Functionality consolidated
- Updated: `app/api/sessions/[id]/events/[eventId]/route.ts` - Improved undo logic for secondaries
- Updated: `components/Timeline.tsx` - Fixed refresh after undo

---

## [4.33.0] - 2025-01-17 - Light Slate Theme UI Redesign

### Changed
- **Complete UI Theme Overhaul:**
  - Transformed from dark background (`#0a0a0a`) to light slate theme (`#e8e8e8`)
  - Maintains grimdark aesthetic with weathered stone/industrial metal appearance
  - Dark header bar retained for brand contrast and TacLog identity

- **Player Panel Redesign:**
  - **Defender (Green) Panel:**
    - Solid sage green background (`#a8c8a8`) - much more visible and less transparent
    - Dark forest green borders (`#3a5a3a`) for strong definition
    - Near-black text (`#0a1a0a`) for maximum readability from distance
    - Bold typography: `font-extrabold` headers, `font-black` army names
    - Army name prominently displayed: "DEFENDER: [Army Name]"
    - Faction displayed as secondary info below army name
  
  - **Attacker (Red) Panel:**
    - Solid dusty rose/crimson background (`#c8a8a8`) - much more visible and less transparent
    - Dark burgundy borders (`#5a2a2a`) for strong definition
    - Near-black text (`#1a0a0a`) for maximum readability from distance
    - Bold typography: `font-extrabold` headers, `font-black` army names
    - Army name prominently displayed: "ATTACKER: [Army Name]"
    - Faction displayed as secondary info below army name

- **Timeline Component:**
  - Updated to light slate background (`#f0f0f0`)
  - Event cards use white backgrounds with colored borders for visibility
  - Filter buttons updated for light theme compatibility
  - Event type colors adjusted for light background (darker, more saturated)

- **Color System Updates:**
  - New light slate palette: `taclog-slate` (`#e8e8e8`), `taclog-slate-light` (`#f0f0f0`), `taclog-slate-dark` (`#d0d0d0`)
  - Defender colors: `taclog-defender-bg`, `taclog-defender-border`, `taclog-defender-text`, `taclog-defender-accent`
  - Attacker colors: `taclog-attacker-bg`, `taclog-attacker-border`, `taclog-attacker-text`, `taclog-attacker-accent`
  - All colors defined in both CSS variables and Tailwind config

### Added
- **Army Identification Display:**
  - `GameStateDisplay` component now accepts `attackerArmyName`, `attackerFaction`, `defenderArmyName`, `defenderFaction` props
  - Army names displayed prominently in panel headers
  - Faction names shown as secondary information
  - Replaces generic "DEFENDER" / "ATTACKER" labels with actual army names

- **Enhanced Readability:**
  - Thicker borders (`border-2`) on all stat boxes for better definition
  - Drop shadows on text for depth and readability
  - Larger font sizes for army names (`text-lg md:text-xl`)
  - Extrabold/black font weights for critical information

### Technical
- Updated: `app/globals.css` - New light slate color variables and defender/attacker color definitions
- Updated: `tailwind.config.ts` - Added light slate and defender/attacker color utilities
- Updated: `components/GameStateDisplay.tsx` - Army name display, panel styling, enhanced typography
- Updated: `components/Timeline.tsx` - Light background compatibility, updated event colors
- Updated: `app/page.tsx` - State management for army names, theme updates
- Updated: `components/GlobalHeader.tsx` - Dark header maintained for brand contrast

### Design Philosophy
- **Light slate theme** provides "whiter background" while maintaining grimdark character
- **Muted but visible** player colors - softer than before but much more solid and readable
- **Distance readability** - Optimized for viewing from 4+ feet away on tablets
- **Clear differentiation** - Defender (green) and Attacker (red) panels are immediately distinguishable
- **Grimdark preserved** - Dark header, orange accents, monospace fonts maintain tactical aesthetic

---

## [4.32.3] - 2025-12-14 - Composition-Based and Add-On Points Tiers

### Added
- **Composition-Based Points Tiers:**
  - Support for units with multiple model types that affect pricing (e.g., Wolf Guard Headtakers + Hunting Wolves)
  - New `CompositionPointsTier` type: `{ composition: { "Model Type": count }, points: number }`
  - Generic pattern detection works across all factions

- **Add-On Points Tiers:**
  - Support for optional models that add flat costs (e.g., Outrider Squad + Invader ATV for +60pts)
  - New `AddOnPointsTier` type: `{ addOn: "Model Name", addOnPoints: number }`
  - Add-on costs are calculated on top of base unit points

- **Enhanced Points Calculation (`UnitBuilder.tsx` & `lib/types.ts`):**
  - Generic calculation logic handles simple, composition-based, and add-on tiers
  - Composition matching for exact model type/count combinations
  - Add-on points added when optional models are present in unit

- **Enhanced Parsing (`patchPointsTiers.ts`):**
  - Automatically detects composition patterns (e.g., "3 X and 3 Y")
  - Detects add-on patterns (price tags with `+` prefix)
  - Categorizes units in output: ðŸ”· Composition, âž• Add-on, âœ… Multi-tier

- **AI Parsing Schema Updates (`app/api/armies/parse/route.ts`):**
  - Added `modelType` field to composition schema for explicit model type identification
  - Updated AI prompt to extract model types from datasheet `compositionData`
  - Enables accurate matching against composition-based and add-on tiers

### Changed
- **Points Tier System:**
  - Extended from simple model-count tiers to three generic patterns
  - All patterns work generically across all factions
  - Backward compatible: simple tiers still work as before

### Data
- Updated: `data/parsed-datasheets/space-marines/Wolf_Guard_Headtakers.json` - Composition-based tiers
- Updated: `data/parsed-datasheets/space-marines/Outrider_Squad.json` - Add-on tier for Invader ATV
- Database seeded with new tier structures

### Technical
- Updated: `lib/types.ts` - Added `CompositionPointsTier` and `AddOnPointsTier` interfaces
- Updated: `components/UnitBuilder.tsx` - Generic points calculation for all tier types
- Updated: `scripts/patchPointsTiers.ts` - Pattern detection for composition and add-on tiers
- Updated: `app/api/armies/parse/route.ts` - Added `modelType` to composition schema

---

## [4.32.2] - 2025-12-14 - Saga of the Great Wolf Detachment

### Added
- **New Space Wolves Detachment: "Saga of the Great Wolf"**
  - Detachment Rule: Master of Wolves (3 Hunting Packs + Howling Onslaught)
  - 6 Stratagems: THE FOE FORESEEN, GRIMNAR'S COMMAND, FENRISIAN FEROCITY, UNRELENTING HUNTERS, EYE OF THE PACK, BATTLE INSTINCTS
  - 4 Enhancements: Grimnar's Mark (20pts), Howlmaw (15pts), Chariots of the Storm (25pts), Skjald's Foretelling (25pts)

### Data
- Updated: `data/wahapedia-import/space-wolves.json` - Added new detachment with stratagems and enhancements
- Updated: `data/parsed-rules/detachments-space-wolves.json` - Added detachment to list

---

## [4.32.1] - 2025-12-14 - Subfaction Stratagem Resolution Fix

### Fixed
- **Subfaction armies showing 0 stratagems:**
  - Space Wolves armies using parent faction detachments (e.g., "Stormlance Task Force") now correctly show stratagems
  - Root cause: API only queried stratagems by the army's direct `factionId`, missing parent faction stratagems
  - Solution: Stratagem lookup now includes both the army's faction AND its parent faction (if any)
  - Affects all subfactions: Space Wolves, Blood Angels, Dark Angels, Deathwatch, Black Templars

### Technical
- Updated: `app/api/armies/route.ts` - Modified stratagem enrichment to query `factionId: { in: [factionId, parentFactionId] }`
- Updated: Prisma include now fetches `faction.parentFactionId` for hierarchy traversal

---

## [4.32.0] - 2025-12-14 - Points Tiers for Variable-Size Units

### Added
- **Points Tiers System:**
  - Units with variable model counts now use tiered pricing (e.g., Wolf Guard Terminators: 5 models = 170pts, 10 models = 340pts)
  - New `pointsTiers` column in Datasheet table stores JSON array of `{models, points}` pairs
  - Patch script `scripts/patchPointsTiers.ts` extracts tiers from cached Wahapedia HTML without API costs

- **Tier-Based Points Calculation (`UnitBuilder.tsx`):**
  - Replaces proportional scaling with exact tier lookup
  - Finds the appropriate tier based on model count
  - Falls back to base `pointsCost` when no tiers available

- **Parser Updates for Future Imports:**
  - `scripts/parseDatasheets.ts` now extracts points tiers via cheerio before LLM parsing
  - Points tiers included in AI context for accurate army list parsing
  - `scripts/seedDatasheets.ts` imports `pointsTiers` to database

### Changed
- **Army Parser Context (`app/api/armies/parse/route.ts`):**
  - Datasheet context now shows points tiers (e.g., "5=170pts, 10=340pts") instead of single base cost
  - AI can now correctly assign points based on model count from imported army lists

- **API Responses:**
  - `GET /api/datasheets` returns `pointsTiers` array for each datasheet
  - `GET /api/datasheets/detail/[id]` includes parsed `pointsTiers`

### Fixed
- **Army points calculation was incorrect for variable-size units:**
  - A 2000pt Space Wolves army was showing as 1415pts because 10-model Terminator squads were charged 170pts instead of 340pts
  - Now correctly uses tier-based pricing from official data

### Technical
- New file: `scripts/patchPointsTiers.ts` - Extracts tiers from cached HTML (no API cost)
- Updated: `prisma/schema.prisma` - Added `pointsTiers` column to Datasheet model
- Updated: `scripts/parseDatasheets.ts` - Extracts and stores points tiers
- Updated: `scripts/seedDatasheets.ts` - Imports pointsTiers to database
- Updated: `components/UnitBuilder.tsx` - Tier-based points calculation
- Updated: `app/api/datasheets/route.ts` - Returns pointsTiers in API
- Updated: `app/api/datasheets/detail/[id]/route.ts` - Returns pointsTiers in API
- Updated: `app/api/armies/parse/route.ts` - Shows tiers in AI context

### Data
- Patched 207 datasheets across 3 factions (Space Marines, Tyranids, Astra Militarum)
- 59 units identified with multi-tier pricing
- 148 units with single-tier (fixed model count)

---

## [4.31.0] - 2025-12-14 - Attachments UX Overhaul

### Added
- **Full-Page Attachments Editor (`/armies/[id]/attachments`):**
  - Dedicated route for attachment management replacing modal overlay
  - Sticky header with faction icon, army name, and back navigation
  - Sticky footer with save state indicator and action buttons
  - Scrollable content area with character cards
  - Presets tab for managing attachment loadouts

- **Squad Numbering for Duplicate Units:**
  - New `lib/unitDisplayHelpers.ts` utility module
  - Units with duplicate datasheets now display as "Wolf Guard Terminators (Squad 1)", "(Squad 2)", etc.
  - `generateSquadNumbers()` creates mapping of unit IDs to squad numbers
  - `getUnitDisplayName()` returns formatted names with squad indicators

- **Portal-Based Dropdown (`SearchableSelect`):**
  - Dropdown now renders via React Portal to `document.body`
  - Escapes scroll container clipping issues
  - Dynamic positioning handles viewport boundaries
  - Scroll/resize event handlers reposition dropdown in real-time

### Changed
- **ID-Based Attachment Storage:**
  - Attachments now stored as `{ characterUnitId: targetUnitId }` instead of `{ characterUnitId: targetUnitName }`
  - Enables proper differentiation of duplicate units
  - Auto-migration: existing name-based attachments converted to ID-based on load
  - `migrateAttachmentsToIds()` handles legacy data gracefully

- **Army Detail Page (`/armies/[id]`):**
  - "Attachments" button now navigates to full page instead of opening modal
  - Attachment display shows unit names with squad numbers
  - Removed `AttachmentsModal` usage (component still exists for reference)

### Technical
- New file: `app/armies/[id]/attachments/page.tsx` - Full-page attachment editor
- New file: `lib/unitDisplayHelpers.ts` - Squad numbering utilities
- Updated: `components/SearchableSelect.tsx` - Portal-based dropdown rendering
- Updated: `app/armies/[id]/page.tsx` - ID-based attachments, navigation to attachments page

---

## [4.30.0] - 2025-12-14 - Army Parser AI Matching & Logging Improvements

### Fixed
- **Wargear incorrectly flagged as issues in review UI:**
  - `getUnitIssues()` was counting ALL wargear abilities as issues regardless of match status
  - `getReviewStats()` was counting ALL wargear toward `wargearItems` and `unitsNeedingReview`
  - Now only flags wargear/abilities if `!abilityId` OR `matchConfidence < 0.8`
  - Units with properly matched wargear (Storm Shield, Death Totem) no longer show review warnings

- **AI mismatching similar character names (Logan Grimnar â†’ Ragnar Blackmane):**
  - Datasheets now sorted alphabetically before sending to AI (improves attention on similar names)
  - Datasheet format now includes ID in name line: `[uuid] DATASHEET: "Name" (pts)`
  - Added explicit exact-match instructions in prompt with concrete example
  - Added warning against similar-sounding name confusion

### Added
- **Enhanced Langfuse logging for army parsing:**
  - Full army list content logged (not just 500 char preview)
  - Complete available datasheets list with IDs, names, factions, weapon/ability counts
  - Detailed unit match breakdown: input name â†’ matched datasheet + ID + confidence
  - `problemMatches` quick-reference showing units with issues
  - Post-processing spans with pre/post state and `changesDetected` flag
  - Full parsed units in trace output for debugging
  - Error traces include stack trace and error type

### Changed
- **AI Prompt improvements (`app/api/armies/parse/route.ts`):**
  - New "EXACT NAME MATCHING" section with 6 explicit rules
  - Concrete example: "Logan Grimnar" â†’ find exact match, use correct ID
  - Warning: "Do NOT match to similar-sounding names"
  - Datasheets section header now indicates alphabetical sorting
  - Datasheet entries show ID prominently before name

### Technical
- Updated: `app/api/armies/parse/route.ts` - Alphabetical sorting, new format, enhanced prompt, comprehensive logging
- Updated: `app/armies/new/page.tsx` - Fixed `getUnitIssues()` and `getReviewStats()` logic

---

## [4.29.1] - 2025-12-14 - Faction Resolution Fix for Subfactions

### Fixed
- **Datasheet linking broken for subfaction armies (Space Wolves, Blood Angels, etc.):**
  - Army creation with compound faction names like "Space Marines (Space Wolves)" failed to resolve faction correctly
  - All units were saved with `datasheetId: null` and `needsReview: true`
  - Root cause: AI-detected faction name overwrote user's dropdown selection, and backend couldn't parse compound names

### Changed
- **Frontend (`app/armies/new/page.tsx`):**
  - Only update faction from AI detection if user hasn't already selected one
  - Preserves user's dropdown selection (e.g., "Space Wolves") which matches database

- **Backend (`app/api/armies/route.ts`):**
  - Added subfaction extraction fallback for compound names
  - Parses "Space Marines (Space Wolves)" â†’ extracts "Space Wolves"
  - Improved faction resolution order: exact match â†’ subfaction extraction â†’ contains match
  - All queries now include `parentFaction` for proper inheritance validation

### Technical Details
- Space Wolves-specific units (Arjac Rockfist, Logan Grimnar) now pass direct faction match
- Space Marines generic units (Lieutenant, Intercessor Squad) now pass parent faction match
- Parent/child faction inheritance (`parentFactionId`) used for validation at lines 237-260

---

## [4.29.0] - 2025-12-14 - Army Roster HTML Export

### Added
- **HTML Export Feature:**
  - New `ðŸ“„ EXPORT` button in army detail page toolbar
  - Downloads a beautifully styled HTML file (`{army-name}_roster.html`)
  - Dark grimdark theme with gold accents (Cinzel + Crimson Pro fonts)
  - Print-friendly CSS that converts to light theme when printing

- **Export Content:**
  - Army header with name, player, faction, detachment, point totals
  - Stats summary: units, models, total wounds
  - Detachment ability section (if available)
  - Character attachments visualization (leader â†’ unit)
  - Characters section (highlighted with gold border)
  - Battle units with full composition breakdown (models Ã— wounds per model)
  - Weapons list with profiles for each unit
  - Abilities displayed as tags
  - Enhancements highlighted per unit
  - Stratagems grouped by type (Battle Tactic, Strategic Ploy, etc.)
  - Available enhancements for the detachment
  - Notable abilities summary

### New API Endpoint
- `GET /api/armies/[id]/export` - Generate HTML army roster
  - Query param `?format=download` triggers file download with `Content-Disposition: attachment`
  - Default (no param) returns viewable HTML in browser
  - Filename: `{army-name}_roster.html`

### Technical
- New: `app/api/armies/[id]/export/route.ts` - HTML generation endpoint
- Updated: `app/armies/[id]/page.tsx` - Added Export button to toolbar
- Documentation: [Army HTML Export](docs/features/ARMY_HTML_EXPORT.md)
- API Reference: [Export Endpoint](docs/api/ARMY_EXPORT_ENDPOINT.md)

---

## [4.28.0] - 2025-12-13 - Datasheet Import: Composition & Wargear Effects

### Added
- **Unit Composition Data (`compositionData`):**
  - Structured model composition parsing for units with mixed wound profiles
  - Per-model-type wound tracking (e.g., Ravener Prime 6W + Raveners 3W)
  - Role classification: "leader" (characters/primes/sergeants) vs "regular" (standard models)
  - Enables accurate total wound calculations for complex units

- **Wargear Stat Modifications (`effects`):**
  - Structured wargear effects parsing (e.g., Relic Shield â†’ wounds: 6)
  - Captures stat changes: wounds, toughness, save, invulnerableSave, movement
  - Enables UI to calculate modified stats based on wargear selections

- **Parser Resume Feature (`--start-from=N`):**
  - Resume parsing from a specific index after crashes
  - Avoids re-parsing already-successful datasheets
  - Example: `npx tsx scripts/parseDatasheets.ts space-marines --override-all --start-from=43`

- **Parser File Validation:**
  - Only processes HTML files with corresponding JSON metadata
  - Excludes orphaned files, faction index files, and scrape summaries
  - Prevents "ENOENT" errors from missing metadata files

### Changed
- **Parser Schemas:**
  - Added `CompositionEntrySchema` with name, role, count, woundsPerModel
  - Added `WargearEffectSchema` with nullable stat modifier fields
  - Extended `AbilitySchema` with optional `effects` field for wargear
  - Extended `DatasheetSchema` with `compositionData` array

- **LLM Prompt:**
  - Enhanced composition extraction with examples (single monsters, mixed leaders, standard squads)
  - Wargear effect extraction rules with explicit null handling
  - Improved accuracy for wound characteristic parsing

### Fixed
- **Schema Validation:**
  - Fixed OpenAI "required fields" error by making all effect fields nullable with explicit `required` array
  - Fixed schema initialization order (WargearEffectSchema before AbilitySchema)

### Database Statistics
| Faction | Datasheets | compositionData | Status |
|---------|------------|-----------------|--------|
| Tyranids | 48 | âœ… All populated | Seeded |
| Space Marines | 96 | âœ… All populated | Seeded |

### Example: Hyperadapted Raveners
```json
{
  "compositionData": [
    { "name": "Ravener Prime", "role": "leader", "count": 1, "woundsPerModel": 6 },
    { "name": "Ravener", "role": "regular", "count": 4, "woundsPerModel": 3 }
  ]
}
// Total: 6 + (4 Ã— 3) = 18 wounds
```

### Example: Captain with Relic Shield
```json
{
  "name": "Relic Shield",
  "type": "wargear",
  "effects": { "wounds": 6, "toughness": null, "save": null, "invulnerableSave": null, "movement": null }
}
// Base Captain: 5W â†’ With Relic Shield: 6W
```

### Technical
- Updated: `scripts/parseDatasheets.ts` - New schemas, prompt, file validation, --start-from flag
- Updated: `scripts/seedDatasheets.ts` - Handles compositionData and effects fields
- Documentation: Updated [Datasheet Parser Guide](docs/guides/DATASHEET_PARSER_GUIDE.md)

---

## [4.27.0] - 2025-12-13 - Army Screen Cleanup: Unified Attachments Modal

### Changed
- **Army Detail Page (`/armies/[id]`) UI Simplification:**
  - **Removed mobile navigation tabs** (TACT/ATT/UNITS) - main view now always shows units roster
  - **Removed sticky save bar** - attachment save/reset controls moved inside modal
  - **Simplified layout** - units roster is now full-width, single-column content
  - **Combined AttachmentsModal and BattleReadyModal** into one unified modal

- **New Unified Attachments Modal:**
  - Two tabs: **Edit Attachments** (configure character attachments) and **Presets** (manage saved loadouts)
  - Save current attachments as named presets (e.g., "VS_ELITE", "AGGRESSIVE")
  - Load, delete, and set default presets
  - Clear dirty state indicator and save/reset controls within modal
  - Cleaner toolbar with single "â­ ATTACHMENTS" button

### Removed
- **Battle Ready button** - functionality merged into Attachments modal
- **BattleReadyModal component usage** - component still exists but no longer used in army detail page
- **Inline attachments panel** - replaced by modal-based workflow
- **Mobile tab navigation** - simplified to single-view approach

### Technical
- Updated: `components/AttachmentsModal.tsx` - Added preset management, tabs, armyId prop
- Updated: `app/armies/[id]/page.tsx` - Removed tabs, sticky bar, BattleReadyModal, simplified layout
- Documentation: Updated [Army Register: Tactics & Battle Ready](docs/features/ARMY_REGISTER_TACTICS_AND_BATTLE_READY.md)

---

## [4.26.0] - 2025-12-13 - Army Register: Tactics & Battle Ready Presets

### Added
- **Tactics quick-glance (`/armies/[id]`):**
  - New `TACTICS` header modal combining detachment selection + stratagem reference
  - Stratagems grouped into **Core** and **Detachment** sections with search
- **Battle Ready attachment presets:**
  - New `AttachmentPreset` model (per-army named presets, default support)
  - New preset CRUD endpoints under `/api/armies/[id]/attachment-presets`
- **Session battle-ready attachments:**
  - `/sessions/new` now supports selecting a preset and tweaking attachments before starting
  - `POST /api/sessions` accepts optional `attackerAttachments` and applies it to character unit instances (`attachedToUnit`)
- **Roster improvements (`/armies/[id]`):**
  - Roster shows **all units** (including characters)
  - Adds unit and roster wounds breakdown (Units / Models / Wounds)

### Changed
- **Army Detail UX (`/armies/[id]`):**
  - Stratagem viewing is now intended through the Tactics modal (no dedicated STRAT tab needed)
  - Attachments can be managed via a dedicated Battle Ready modal in addition to the inline attachments panel

### Technical
- New: `components/TacticsModal.tsx`
- New: `components/BattleReadyModal.tsx`
- New: `docs/features/ARMY_REGISTER_TACTICS_AND_BATTLE_READY.md`
- New: `docs/api/SESSIONS_ENDPOINT.md`
- New: `docs/api/ARMY_ATTACHMENT_PRESETS_ENDPOINT.md`
- Updated: `app/api/armies/[id]/route.ts` (include `detachment` metadata for stratagems; include `units.fullDatasheet`)
- Updated: `app/api/sessions/route.ts` (apply `attackerAttachments` to character unit instances)

---

## [4.25.0] - 2025-12-13 - Army Icons & Attachments UX Refresh

### Added
- **Army Detail Attachments Panel (`/armies/[id]`):**
  - Dedicated attachments panel listing character units
  - Searchable attach-target picker for faster selection
  - Sticky save bar with dirty state, reset, and clear-all actions

### Changed
- **Army icon display:**
  - Army Library cards now show faction icons next to faction names
  - Army Detail header and unit rows now show faction + unit icons (with emoji fallback)

### Fixed
- **Icon resolution fallbacks:**
  - `app/api/icons/resolve/route.ts` now falls back to `public/icons/...` when no per-user icon exists (including unauthenticated requests)
  - `lib/hooks/useUnitIcon.ts` now supports anonymous filesystem icon fallback via `/api/icons/resolve`

### Added
- **Global icon storage (Supabase):**
  - New `GlobalUnitIcon` table + Prisma schema model for globally shared unit icons.
  - Admin icon generation now uploads icons to Supabase Storage bucket `unit-icons` and persists a global mapping.
  - Icon resolution now prefers global icons (Supabase) before user icons and filesystem fallbacks.

---

## [4.24.0] - 2025-12-10 - Army Parser Review UI & Weapon Matching Enhancements

### Added
- **Enhanced Review UI (`/armies/new`):**
  - Review summary banner showing total issues (unmatched weapons, wargear items, units needing review)
  - Per-component confidence indicators for each weapon/ability in expanded view
  - Inline issue display showing specific problematic items (e.g., "2 weapons not matched: Axe Morkai, Paired combat blades")
  - "Mark as Reviewed" button to manually dismiss review flags after verification
  - Color-coded confidence dots (green â‰¥80%, yellow 50-80%, red <50%)
  - Improved grimdark styling with corner brackets and TacLog color palette

- **Weapon Matching Post-Processing:**
  - Automatic base name matching for unmatched weapons
  - Profile variant detection (strike/sweep, frag/krak, standard/supercharge)
  - Preference for "strike", "standard", or "krak" variants when multiple exist
  - Full weapon stats copied from matched database entries
  - Console logging of post-processing improvements

- **AI Prompt Enhancements:**
  - Comprehensive weapon naming conventions documentation
  - Profile variant matching strategy (e.g., "Axe Morkai" â†’ "Axe Morkai â€” strike")
  - Ability suffix recognition (prefer versions with `[ability]` tags)
  - Removed 200 weapon limit - now sends all 528 weapons to AI for better matching

### Fixed
- **Wargear Classification:**
  - Fixed misclassification of wargear items (Storm Shield, Death Totem) as weapons
  - Wargear now correctly placed in `abilities` array with `type: "wargear"`
  - Updated AI prompt to distinguish weapons (attack profiles) from wargear (passive abilities)

- **Review Flag Logic:**
  - Fixed "0 issues but needs review" bug - now only shows review UI when actual issues detected
  - Review stats now count only detectable issues, not AI's internal flags

- **Detachment Access:**
  - Subfactions (e.g., Space Wolves) now have access to parent faction detachments (e.g., Space Marines)
  - Space Wolves can now select from 21 detachments (17 Space Marines + 4 Space Wolves-specific)

### Technical
- Updated: `app/api/armies/parse/route.ts` - Enhanced AI prompt, added post-processing function
- Updated: `app/armies/new/page.tsx` - Enhanced review UI with detailed confidence display
- Updated: `app/api/factions/[id]/detachments/route.ts` - Include parent faction detachments
- Documentation: Updated [Army Parser Datasheet System](docs/features/ARMY_PARSER_DATASHEET_SYSTEM.md)

---

## [4.23.0] - 2025-12-04 - Admin Datasheets Management

### Added
- **Datasheets Admin Panel (`/admin/datasheets`):**
  - Full CRUD operations for unit datasheets across all factions
  - Advanced filtering: faction, role, enabled status, search
  - Sortable columns (name, faction, role, points)
  - Pagination with configurable page size
  - Bulk selection with enable/disable actions
  - Unit icons displayed from Icon Generator (matched by unitName + faction)

- **Faction Detail Page Enhancement:**
  - Expandable datasheets section (click on Datasheets count)
  - Inline enable/disable toggles
  - Edit and Delete buttons per datasheet
  - Role and search filtering
  - Link to full datasheets admin with faction pre-filtered

- **DatasheetEditorModal Integration:**
  - Multi-step datasheet editor for create/edit
  - Pre-fills faction when creating from faction page
  - Full validation with Zod schemas
  - Version snapshot created on each save

- **Unit Icons in Datasheet Lists:**
  - Icons matched by datasheet name + faction (same as Icon Generator)
  - Role-based emoji fallbacks (Character, Battleline, Monster, Vehicle)
  - Icons sync automatically when generated via Icon Generator

### New API Endpoints
- `GET /api/admin/datasheets` - List datasheets with filters, search, pagination
- `POST /api/admin/datasheets` - Create new datasheet with weapons/abilities
- `GET /api/admin/datasheets/[id]` - Get full datasheet details
- `PUT /api/admin/datasheets/[id]` - Update datasheet (creates new version)
- `PATCH /api/admin/datasheets/[id]` - Toggle enabled status
- `DELETE /api/admin/datasheets/[id]` - Delete datasheet with cascade warnings

### Technical
- New: `app/admin/datasheets/page.tsx` - Dedicated datasheets admin page
- New: `app/api/admin/datasheets/route.ts` - Datasheets list API with icon lookup
- New: `app/api/admin/datasheets/[id]/route.ts` - Single datasheet CRUD
- Updated: `app/admin/factions/[id]/page.tsx` - Added datasheets section
- Updated: `app/admin/layout.tsx` - Added Datasheets navigation link
- Documentation: [Admin Datasheets Management](docs/features/ADMIN_DATASHEETS_MANAGEMENT.md)

---

## [4.22.0] - 2025-12-01 - Faction Data Import System

### Added
- **Complete Faction Data Import System:**
  - New `scripts/scrapeWahapediaComplete.ts` - Comprehensive scraper extracting army rules, detachments, stratagems, and enhancements
  - New `scripts/importFaction.ts` - JSON-to-database import with validation and upsert support
  - New `scripts/splitSpaceMarineChapters.ts` - Splits combined Space Marines data into separate chapter factions
  - New `scripts/resetGameData.ts` - Safe database reset preserving user data

- **26 Complete Factions Imported:**
  - All major factions with complete detachment data
  - Space Marine divergent chapters as separate factions (Blood Angels, Dark Angels, Space Wolves, Deathwatch)
  - Parent faction relationships maintained for chapter factions
  - 165 detachments, 970 stratagems, 654 enhancements, 40 army rules

- **Admin UI Import/Export Features:**
  - "Import from Wahapedia" button triggers automated scraping
  - JSON file upload for manual faction data import
  - Per-faction JSON export for backup/editing
  - Bulk export for all faction data

- **New API Routes:**
  - `POST /api/admin/import/wahapedia` - Trigger Wahapedia scrape + import
  - `POST /api/admin/import/json` - Import uploaded JSON file
  - `GET /api/admin/export/[factionId]` - Export faction as JSON

### Data Schema
- **JSON Import Format** (`data/import-schema.json`):
  - Faction with keywords and parent faction
  - Army rules array with name, description, flavorText
  - Detachments with ability name/description
  - Stratagems with cpCost, type, when/target/effect, restrictions
  - Enhancements with pointsCost, description, restrictions

### Database Statistics
| Metric | Count |
|--------|-------|
| Factions | 26 |
| Detachments | 165 |
| Stratagems | 970 |
| Enhancements | 654 |
| Army Rules | 40 |

### Chapter Breakdown
| Faction | Parent | Detachments | Stratagems | Enhancements |
|---------|--------|-------------|------------|--------------|
| Space Marines | - | 18 | 102 | 72 |
| Blood Angels | Space Marines | 3 | 18 | 12 |
| Dark Angels | Space Marines | 5 | 30 | 20 |
| Space Wolves | Space Marines | 4 | 24 | 16 |
| Deathwatch | Space Marines | 2 | 12 | 4 |

### Files Created
- `scripts/scrapeWahapediaComplete.ts` - Complete faction scraper
- `scripts/importFaction.ts` - JSON import script
- `scripts/splitSpaceMarineChapters.ts` - Chapter separation utility
- `scripts/resetGameData.ts` - Database reset script
- `data/import-schema.json` - JSON validation schema
- `data/templates/faction-template.json` - Manual entry template
- `data/wahapedia-import/*.json` - 26 faction JSON files
- `app/api/admin/import/wahapedia/route.ts` - Wahapedia import API
- `app/api/admin/import/json/route.ts` - JSON import API
- `app/api/admin/export/[factionId]/route.ts` - Export API

---

## [4.21.0] - 2025-12-01 - Flat Faction Architecture & Detachment Normalization

### Changed
- **Flat Faction Architecture:**
  - Removed parent/child hierarchy - all factions are now top-level entities
  - Each divergent chapter (Space Wolves, Blood Angels, Dark Angels, Black Templars, Deathwatch) now has its own complete datasheet roster
  - Datasheets duplicated from source (Space Wolves) to all chapters with chapter-specific keywords
  - New `isEnabled` Boolean field on Datasheet controls army builder visibility

- **Chapter-Specific Unit Restrictions:**
  - Black Templars: Librarian units disabled (PSYKER restriction)
  - Deathwatch: Scout Squad disabled (per official rules)
  - Restriction enforcement via `isEnabled: false` flag (not data deletion)

- **Detachment Normalization:**
  - Created 60 `Detachment` records extracted from stratagem data
  - All 301 stratagems now linked via `detachmentId` foreign key
  - New "Core" faction for universal stratagems (8 stratagems)
  - Core stratagems centralized and removed duplicates from other factions

### Database Changes
- **Datasheet model:** Added `isEnabled Boolean @default(true)` with index
- **Faction model:** `parentFactionId` set to null for all factions (flattened)
- **Detachment table:** Populated with 60 records across 9 factions
- **StratagemData:** `detachmentId` now populated for 301 stratagems

### New Scripts
- `scripts/migrateFactionHierarchy.ts` - Flatten factions, duplicate datasheets, apply restrictions
- `scripts/normalizeDetachments.ts` - Extract and normalize detachments from stratagems

### Admin UI
- Updated `/admin/factions` to display flat list (no hierarchy)
- Added disabled datasheet counts per faction
- Removed parent/child faction grouping

### Data Statistics
| Faction | Datasheets | Disabled | Detachments | Stratagems |
|---------|-----------|----------|-------------|------------|
| Astra Militarum | 64 | 0 | 0 | 0 |
| Black Templars | 102 | 4 | 4 | 24 |
| Blood Angels | 96 | 0 | 4 | 24 |
| Core | - | - | 1 | 8 |
| Dark Angels | 96 | 0 | 5 | 30 |
| Deathwatch | 96 | 1 | 1 | 6 |
| Space Marines | 96 | 0 | 33 | 156 |
| Space Wolves | 96 | 0 | 11 | 40 |
| Tyranids | 49 | 0 | 1 | 13 |

---

## [4.20.0] - 2025-11-30 - Admin Panel for Factions, Detachments & Stratagems

### Added
- **Admin Panel (`/admin/factions`):**
  - Hierarchical view of Factions â†’ Detachments â†’ Stratagems
  - Full CRUD operations for all three entity types
  - Expandable/collapsible sections for easy data browsing
  - Quick stats showing counts at each level
  - Bulk export/import for JSON data management

- **Admin Authorization System:**
  - New `isAdmin` field on User model
  - `requireAdminAuth()` middleware for API route protection
  - Admin-only navigation link in hamburger menu
  - 401/403 responses for unauthorized access

- **New Detachment Model:**
  - Proper relational structure linking factions to detachments
  - Fields: name, faction, description, detachmentAbility, sourceBook, edition
  - Relations to StratagemData and Enhancement models
  - Backward compatibility with existing string-based detachment fields

### New API Endpoints
- `GET/POST /api/admin/factions` - List and create factions
- `GET/PUT/DELETE /api/admin/factions/[id]` - Single faction CRUD
- `GET/POST /api/admin/factions/[id]/detachments` - Detachments for a faction
- `GET/PUT/DELETE /api/admin/detachments/[id]` - Single detachment CRUD
- `GET/POST /api/admin/detachments/[id]/stratagems` - Stratagems for a detachment
- `GET/PUT/DELETE /api/admin/stratagems/[id]` - Single stratagem CRUD
- `GET /api/admin/bulk/export` - Export all data as JSON
- `POST /api/admin/bulk/import` - Import data from JSON

### Database Schema Changes
- **User model:** Added `isAdmin Boolean @default(false)`
- **Detachment model (new):** Full entity with faction relations
- **StratagemData model:** Added `detachmentId` foreign key (optional, preserves legacy `detachment` string)
- **Enhancement model:** Added `detachmentId` foreign key (optional, preserves legacy `detachment` string)

### Technical
- New: `lib/auth/adminAuth.ts` - Admin authorization helper
- New: `app/admin/layout.tsx` - Admin layout with sidebar navigation
- New: `app/admin/factions/page.tsx` - Main admin dashboard
- New: `app/admin/factions/[id]/page.tsx` - Faction detail/edit page
- New: `app/admin/detachments/[id]/page.tsx` - Detachment detail/edit page
- New: `app/admin/stratagems/[id]/page.tsx` - Stratagem detail/edit page
- Updated: `components/HamburgerMenu.tsx` - Admin link for admin users
- Documentation: [Admin Panel](docs/features/ADMIN_PANEL.md)

---

## [4.19.0] - 2025-11-29 - Datasheet Versioning & Custom Datasheets

### Added
- **Custom Datasheet System:**
  - Create custom datasheets from scratch via multi-step editor modal
  - Fork/copy any existing datasheet to create your own editable version
  - Edit stats, weapons, abilities, and wargear options on your custom datasheets
  - Share custom datasheets via private links or make them public
  - "MY DATASHEETS" tab to view all your custom creations

- **Datasheet Versioning (Wayback Machine):**
  - Full version history for all datasheets (official and custom)
  - Each edit creates a new version with complete JSON snapshot
  - Version labels and changelogs for tracking balance updates
  - `DatasheetVersion` model stores immutable snapshots of datasheet state

- **Datasheet Library UI Enhancements:**
  - Source filter tabs: ALL / OFFICIAL / MY DATASHEETS
  - Action menu (â‹®) on hover for every datasheet card
  - Fork/Copy option available to all users
  - Edit, Share, Delete options for your own datasheets
  - Visual badges: CUSTOM (purple), FORK (cyan), version number
  - "+ CREATE CUSTOM" button with login prompt if not authenticated

- **Sharing System:**
  - Visibility settings: private, link-only, or public
  - Share tokens for private link-based sharing
  - Import shared datasheets into your collection

### New API Endpoints
- `GET /api/datasheets/mine` - Fetch user's owned datasheets
- `POST /api/datasheets` - Create new custom datasheet
- `PUT /api/datasheets/detail/[id]` - Update datasheet with version creation
- `DELETE /api/datasheets/detail/[id]` - Delete custom datasheet
- `POST /api/datasheets/detail/[id]/fork` - Fork/copy a datasheet
- `GET/POST /api/datasheets/detail/[id]/share` - Manage sharing settings
- `GET /api/datasheets/detail/[id]/versions` - List version history
- `GET /api/datasheets/detail/[id]/versions/[versionId]` - Get version snapshot
- `GET /api/datasheets/public` - Browse public/community datasheets
- `GET/POST /api/datasheets/import/[shareToken]` - Import shared datasheet

### Database Schema Changes
- **Datasheet model:** Added `isOfficial`, `ownerId`, `forkedFromId`, `currentVersion`, `visibility`, `shareToken` fields
- **DatasheetVersion model (new):** Stores version snapshots with `versionNumber`, `versionLabel`, `snapshotData`, `changelog`
- **User model:** Added relations for owned datasheets and created versions

### Technical
- New: `lib/datasheetValidation.ts` - Zod schemas for datasheet CRUD validation
- New: `components/DatasheetEditorModal.tsx` - Multi-step datasheet editor
- New: `components/ShareModal.tsx` - Sharing settings UI
- New: `components/VersionHistoryPanel.tsx` - Version history display
- New: `scripts/seedDatasheetVersions.ts` - Initialize versions for existing datasheets
- Updated: `app/datasheets/page.tsx` - Full UI overhaul with tabs, actions, modals
- Updated: `app/api/datasheets/route.ts` - Added versioning fields to response
- Documentation: [Datasheet Versioning System](docs/features/DATASHEET_VERSIONING_SYSTEM.md)

---

## [4.18.0] - 2025-11-28 - Icon Generation Prompt & UI Improvements

### Changed
- **Icon Generation Prompt Overhaul:**
  - Switched from generic "flat vector art" style to anime-style character portraits
  - New prompt emphasizes: entire subject fits in frame, no borders, centered composition
  - White background with orange border (#ff6b00) for better contrast against dark UI
  - Upgraded model from `gemini-2.5-flash-image` to `gemini-3-pro-image-preview` for better quality

- **Larger Icon Display:**
  - Increased DatasheetCard icon size from 32px (`w-8 h-8`) to 64px (`w-16 h-16`)
  - Icons now more visible and distinguishable in the unit grid

### Technical
- Updated: `app/api/admin/icons/generate/route.ts` (new prompt, model upgrade)
- Updated: `components/DatasheetCard.tsx` (larger icon container)
- Documentation: [Unit Icon Generation](docs/features/UNIT_ICON_GENERATION.md)

---

## [4.17.0] - 2025-11-28 - Per-User Icon Storage (Vercel Blob)

### Added
- **Per-User Icon Storage:**
  - Icons are now stored in Vercel Blob instead of the filesystem for authenticated users.
  - New `UnitIcon` database model links icons to users, datasheets, and blob URLs.
  - User-specific icons â€“ each user can have their own custom icons that don't affect other users.
  
- **Icon Resolution System:**
  - New `/api/icons/resolve` endpoint for fetching user-specific icons.
  - Supports single icon lookup (GET) and batch lookup (POST).
  - Checks database first (user icons), then falls back to filesystem (legacy icons).

### Changed
- **Datasheets API (`/api/datasheets`):**
  - Now returns user-specific icons from the database when available.
  - Falls back to filesystem icons for legacy/unauthenticated users.
  
- **Datasheet Detail Page:**
  - Uses icon resolution API instead of direct filesystem checks.
  - Icons update immediately after generation without page refresh.

- **Admin Icons Status API:**
  - Checks database for user icons in addition to filesystem scan.
  - Shows correct icon status for both blob and legacy icons.

### Technical
- **Prisma Schema:** Added `UnitIcon` model with `userId`, `datasheetId`, `blobUrl`, `blobKey` fields.
- **Environment Variables:** Requires `BLOB_READ_WRITE_TOKEN` for Vercel Blob storage.
- **Dependencies:** Uses `@vercel/blob` for cloud storage.
- **Documentation:** [Unit Icon Generation](docs/features/UNIT_ICON_GENERATION.md)

---

## [4.16.0] - 2025-11-28 - Unit Icon Generation Workflow

### Added
- **Icon Generator Modal (`components/tools/IconGeneratorModal.tsx`):**
  - Shared modal for searching reference images, overriding style prompts, and calling Gemini.
  - One-column preview layout with larger thumbnails for easier review.
- **Admin Icon Dashboard (`/admin/icons`):**
  - Filter datasheets by faction or â€œmissing iconâ€.
  - Generate/regenerate icons with inline status updates.
- **Inline Icon Editing:**
  - Datasheet headers and live unit cards now show always-visible âœŽ buttons.
  - Direct access to the Icon Generator Modal with unit/faction pre-filled.

### Technical
- **New API Endpoints:**
  - `app/api/admin/icons/search/route.ts` â€“ wraps Google Custom Search for Wahapedia-style image lookups.
  - `app/api/admin/icons/generate/route.ts` â€“ calls `gemini-2.5-flash-image`, resizes output to 256Ã—256 PNG, and saves under `public/icons/<faction>/<unit>.png`.
- **Dependencies:** Added `googleapis`, `@google/genai`, `sharp`, and `fs-extra`.
- **Environment Variables:** Requires `GOOGLE_API_KEY`, `GOOGLE_SEARCH_API_KEY` (optional), and `GOOGLE_SEARCH_CX`.
- **Documentation:** [Unit Icon Generation](docs/features/UNIT_ICON_GENERATION.md)

# Changelog

All notable changes to TacLog will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [4.15.0] - 2025-11-26 - AI Damage Calculator (Voice-Activated)

### Added
- **Voice-Activated Damage Calculations:**
  - Ask "How much damage does [Unit] do to [Target]?" via voice
  - AI extracts unit names, weapon selection, and modifiers from natural speech
  - Automatic phase-aware weapon selection (ranged for Shooting, melee for Fight)
  - Full weapon comparison showing ALL available weapons with damage breakdowns

- **Weapon Rules Engine (`lib/weaponRulesEngine.ts`):**
  - Phase-based weapon filtering (melee for Fight, ranged for Shooting)
  - EXTRA ATTACKS weapon detection and proper handling
  - Extra attacks weapons calculated IN ADDITION to primary weapon (per 10th Edition rules)
  - Profile group detection for weapons with variants (e.g., "Axe Morkai â€” strike/sweep")
  - Weapon classification (ranged, melee, pistol)
  - Ability parsing from weapon data (RAPID FIRE, SUSTAINED HITS, ANTI-X, etc.)

- **Damage Results Modal (`components/DamageResultsModal.tsx`):**
  - Displays voice-triggered damage calculation results
  - Clear breakdown showing weapon damage + extra attacks = total
  - Weapon comparison for units with multiple weapon options
  - Expandable details with full stats (hits, wounds, unsaved, roll rates)
  - Results stack for multiple calculations in a session
  - Accessible via hamburger menu "View Damage Results"

- **Timeline Integration:**
  - Damage calculations saved as `damage_calc` timeline events
  - Click on any damage_calc event to re-view the full calculation
  - Visual indicator (ðŸ‘ VIEW badge) on clickable damage events
  - Full metadata preserved for historical review

### Changed
- **AI Tool Definition (`lib/aiTools.ts`):**
  - Enhanced `estimate_damage` tool with explicit parameter descriptions
  - Clear guidance for AI to separate unit names from weapon names
  - Modifier mapping documentation (voice commands â†’ API parameters)

- **System Prompt Updates (`lib/contextBuilder.ts`):**
  - Added `DAMAGE_CALCULATION_RULES` with explicit examples
  - Phase-aware weapon selection guidance
  - Modifier mapping from voice commands

- **Tool Handler Refactor (`lib/toolHandlers.ts`):**
  - Calculates damage for ALL eligible weapons (not just "best")
  - Includes extra attacks in combined totals
  - Returns structured comparison data for UI display

### Fixed
- **Extra Attacks Bug:** Weapons with EXTRA ATTACKS ability (e.g., "Tyrnak and Fenrir") now properly add their attacks to the main weapon's damage
- **Weapon Selection:** Extra attacks weapons excluded from primary weapon selection (they're additions, not alternatives)
- **Timeline Error:** Added `damage_calc` to Timeline's eventTypeColors/Icons/Labels to prevent undefined errors

### Technical
- New: `lib/weaponRulesEngine.ts` - Weapon filtering and classification engine
- New: `lib/rulesReference.ts` - Added `DAMAGE_CALCULATION_RULES` constant
- Updated: `lib/toolHandlers.ts` - Complete refactor of `estimateDamage` function
- Updated: `lib/types.ts` - Added WeaponProfile, EligibleWeaponsResult types
- Updated: `components/Timeline.tsx` - Clickable damage_calc events
- Updated: `components/HamburgerMenu.tsx` - Damage results count badge
- New: `components/DamageResultsModal.tsx` - Voice damage results display
- Documentation: `docs/features/AI_DAMAGE_CALCULATOR.md`

## [4.14.0] - 2025-11-25 - MathHammer Calculator Enhancement

### Added
- **Corrected Math Engine (10th Edition Rules):**
  - Lethal Hits: Now correctly triggers on ANY 6 (including rerolled 6s)
  - Sustained Hits: Extra hits do NOT benefit from Lethal Hits (fixed)
  - Anti-X Logic: Only changes critical wound threshold, base wound target from S vs T (fixed)
  - Devastating Wounds: Critical wounds become mortals equal to damage characteristic
  - Feel No Pain: Confirmed working against ALL damage including mortals
  - Modifiers Cap: +1/-1 cap enforced per 10th Edition rules

- **Probability Distribution Calculations:**
  - `binomialPMF()` - Binomial probability mass function
  - `calculateKillProbabilities()` - Kill probability distributions for target units
  - `calculateDamageWithProbabilities()` - Full damage calculation with probability data
  - Visual probability bars: P(kill 0), P(kill 1), P(kill 2), P(kill 3+)
  - Key stat display: "X% chance to kill at least 1 model"

- **Core Stratagems Integration:**
  - `data/parsed-rules/core-stratagems.json` - All 11 core stratagems with calculator effects
  - 7 calculator-relevant stratagems: Command Re-roll, Fire Overwatch, Go to Ground, Smokescreen, Epic Challenge, Grenade, Tank Shock
  - 4 non-calculator stratagems: Counter-Offensive, Insane Bravery, Rapid Ingress, Heroic Intervention
  - `scripts/seedCoreStratagems.ts` - Database seeding script

- **Enhanced Calculator UI:**
  - Stratagem toggles section with attacker/defender categories
  - CP cost tracking for active stratagems
  - Kill probability visualization with progress bars
  - Mortal wounds tracking displayed separately
  - Active stratagems indicator in results summary

### Changed
- **Prisma Schema Updates:**
  - Added `calculatorEffect Json?` field to `StratagemData` model
  - Added `isCalculatorRelevant Boolean` and `calculatorEffect Json?` to `CoreStratagem` model

- **DamageResult Interface:**
  - Added `mortal_wounds: number` field for tracking mortals separately
  - Added `probability_to_kill` object with `atLeast1` and `exactly[]` arrays

### Fixed
- **Math Calculation Bugs:**
  - Sustained Hits extra hits incorrectly benefiting from Lethal Hits
  - Anti-X incorrectly modifying base wound target instead of just crit threshold
  - Lethal Hits not properly triggering on rerolled 6s

### Technical
- Updated: `lib/damageCalculation.ts` (complete rewrite of calculation engine)
- Updated: `app/calculator/page.tsx` (stratagem toggles, probability display)
- Updated: `components/tools/DamageCalculatorModal.tsx` (mirrored enhancements)
- New: `data/parsed-rules/core-stratagems.json`
- New: `scripts/seedCoreStratagems.ts`
- Documentation: `docs/features/MATHHAMMER_CALCULATOR_ENHANCEMENT.md`

## [4.13.0] - 2025-11-24 - Damage Calculator (MathHammer)

### Added
- **Damage Calculator UI:**
  - Quick calculator modal accessible from hamburger menu
  - Full-page calculator at `/calculator` for detailed analysis
  - Game-aware unit selection from current battle session
  - Complete weapon selection with stats display
  - Comprehensive modifier system (rerolls, cover, special abilities)
  - Real-time statistical calculations
  - Detailed results breakdown with probabilities

- **Calculation Engine (`lib/damageCalculation.ts`):**
  - Full 10th Edition combat mechanics support
  - Hit rolls with rerolls and modifiers
  - Wound rolls with S vs T comparison
  - Save rolls with AP, cover, and invulnerable saves
  - Special abilities: Lethal Hits, Sustained Hits, Devastating Wounds, Anti-X, Twin-Linked
  - Feel No Pain damage mitigation
  - Accurate models-killed calculation

- **Voice Integration:**
  - `estimate_damage` AI tool for voice-driven calculations
  - Natural language queries: "How much damage would X do to Y?"
  - Uses same calculation engine as manual interface
  - Formatted results in timeline

### Changed
- **Units API Enhancement:**
  - `/api/sessions/[id]/units` now includes full weapon relations
  - Eliminated need for separate datasheet fetches
  - Improved performance for unit-dependent features

### Fixed
- **Type Safety Improvements:**
  - Added `requiresOverride` field to all ValidationResult objects
  - Fixed validation message fallbacks across all tool handlers
  - Corrected Prisma query in damaged ability lookup
  - Fixed stratagem usage validation for per-turn/phase limits
  - Improved unit health validation using correct model fields

- **UI Fixes:**
  - Fixed apostrophe escaping in reactive ability display
  - Corrected Secondary Objectives modal field names (category, maxVPTotal, maxVPPerTurn)
  - Fixed useCallback dependencies in modal components

### Technical
- New components: `DamageCalculatorModal.tsx`, `app/calculator/page.tsx`
- Enhanced: `lib/toolHandlers.ts`, `lib/validationRules.ts`, `lib/contextBuilder.ts`
- Documentation: `docs/features/DAMAGE_CALCULATOR.md`

## [4.12.0] - 2025-11-22 - Global Navigation & Grimdark UI

### Added
- **Global Navigation System:**
  - Persistent header on all non-battle pages (`/armies`, `/sessions`).
  - Context-aware "RETURN TO BATTLE" button when a game is active.
  - Seamless navigation between app sections.

- **Grimdark Menu Redesign:**
  - Replaced standard hamburger drawer with a floating "Dataslate" panel.
  - Custom rotating Cog icon trigger.
  - Tactical aesthetics: terminal typography, metallic borders, "power-up" animations.
  - Simplified, flat "computer panel" look to match battle screen.

- **Army Cogitator UI Update (`/armies`):**
  - Complete visual overhaul matching the Grimdark aesthetic.
  - "Dataslate" card frames with scanline effects.
  - Unified action bar combining navigation, filtering, and sorting.
  - Compact, tactical button designs (`h-10`, `.btn-depth`).
  - "Tactical Assets" drawer for stratagems within army cards.

- **Session Manager UI Update (`/sessions`):**
  - "System Log" terminal styling.
  - Distinct "Active Operations" vs "Archived Logs" sections.
  - Dynamic Imperial Date display (e.g., `0.123.005.M42`).

### Changed
- **Navigation Logic:**
  - Implemented `NavigationWrapper` to intelligently switch headers based on route.
  - Refactored `HamburgerMenu` to be modular and context-aware.
- **Menu Labels:** Updated overly thematic terms to clear, direct actions (e.g., "Past Games" â†’ "Sessions").

### Removed
- **AI Badge:** Removed redundant "âš  AI" warning from the main header.

## [4.11.0] - 2025-11-20 - Army Management UI Overhaul
... (previous entries remain unchanged)
